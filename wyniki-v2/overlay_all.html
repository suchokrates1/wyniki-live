<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Score Overlay - All Courts</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: transparent;
            overflow: hidden;
            color: white;
        }

        .scoreboard {
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.95), rgba(13, 71, 161, 0.95));
            border-radius: 12px;
            padding: 14px 18px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.15);
            transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scoreboard.hidden-slide {
            opacity: 0;
            transform: scale(0.8);
            pointer-events: none;
        }

        .court-label {
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
            opacity: 0.85;
        }

        .player-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .flag {
            width: 28px;
            height: 20px;
            object-fit: cover;
            border-radius: 3px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .serve-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .player-row.serving .serve-dot { opacity: 1; }

        .player-name {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .scores {
            display: flex;
            gap: 5px;
            align-items: center;
            flex-shrink: 0;
        }

        .score {
            min-width: 30px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
            padding: 3px 5px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }

        .score.points {
            background: rgba(255, 255, 255, 0.15);
            min-width: 34px;
        }

        .score.tiebreak {
            background: rgba(76, 175, 80, 0.5);
        }

        .match-inactive .player-row { opacity: 0.4; }

        /* 4-corner layout */
        .layout-all {
            position: fixed;
            width: 100vw;
            height: 100vh;
            transition: opacity 1s ease;
        }

        .layout-all.auto-hidden {
            opacity: 0;
            pointer-events: none;
        }

        .corner-court {
            position: absolute;
            width: 340px;
        }

        .corner-court.top-left    { top: 20px;    left: 20px; }
        .corner-court.top-right   { top: 20px;    right: 20px; }
        .corner-court.bottom-left { bottom: 20px; left: 20px; }
        .corner-court.bottom-right{ bottom: 20px; right: 20px; }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        const allCourtIds = ['1', '2', '3', '4'];
        const SETTINGS_POLL_MS = 2000;
        const corners = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];

        let courts = {};
        let overlaySettings = {
            courts_visible: { '1': true, '2': true, '3': true, '4': true },
            auto_hide: false,
            show_stats: false,
        };
        let eventSource = null;

        function renderScoreboard(kortId, label) {
            const court = courts[kortId] || {};
            const playerA = court.A || {};
            const playerB = court.B || {};
            const matchActive = court.match_status?.active || false;
            const isVisible = overlaySettings.courts_visible[kortId] !== false;

            const activeClass = matchActive ? '' : 'match-inactive';
            const slideClass = isVisible ? '' : 'hidden-slide';

            const currentSet = court.current_set || 1;
            const sets = [];
            for (let s = 1; s <= 3; s++) {
                if (s <= currentSet || (playerA[`set${s}`] > 0 || playerB[`set${s}`] > 0)) {
                    sets.push({ a: playerA[`set${s}`] || 0, b: playerB[`set${s}`] || 0 });
                }
            }
            if (sets.length === 0) sets.push({ a: 0, b: 0 });

            const isTie = court.tie?.visible || false;
            const pA = isTie ? (court.tie?.A || 0) : (playerA.points || '0');
            const pB = isTie ? (court.tie?.B || 0) : (playerB.points || '0');
            const pCls = isTie ? 'score points tiebreak' : 'score points';

            return `
                <div class="scoreboard ${activeClass} ${slideClass}">
                    <div class="court-label">${label}</div>
                    <div class="player-row ${court.serve === 'A' ? 'serving' : ''}">
                        <div class="serve-dot"></div>
                        ${playerA.flag_url ? `<img src="${playerA.flag_url}" alt="" class="flag" onerror="this.style.display='none'">` : ''}
                        <div class="player-name">${playerA.surname || playerA.full_name || '\u2014'}</div>
                        <div class="scores">
                            ${sets.map(s => `<div class="score">${s.a}</div>`).join('')}
                            ${matchActive ? `<div class="${pCls}">${pA}</div>` : ''}
                        </div>
                    </div>
                    <div class="player-row ${court.serve === 'B' ? 'serving' : ''}">
                        <div class="serve-dot"></div>
                        ${playerB.flag_url ? `<img src="${playerB.flag_url}" alt="" class="flag" onerror="this.style.display='none'">` : ''}
                        <div class="player-name">${playerB.surname || playerB.full_name || '\u2014'}</div>
                        <div class="scores">
                            ${sets.map(s => `<div class="score">${s.b}</div>`).join('')}
                            ${matchActive ? `<div class="${pCls}">${pB}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function render() {
            const app = document.getElementById('app');
            const anyActive = allCourtIds.some(id => courts[id]?.match_status?.active);
            const autoHidden = overlaySettings.auto_hide && !anyActive;

            app.innerHTML = `
                <div class="layout-all ${autoHidden ? 'auto-hidden' : ''}">
                    ${allCourtIds.map((id, i) => `
                        <div class="corner-court ${corners[i]}">
                            ${renderScoreboard(id, 'Kort ' + id)}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function connectSSE() {
            if (eventSource) eventSource.close();
            eventSource = new EventSource('/api/stream');

            eventSource.addEventListener('court_update', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    if (data.court_id) {
                        const { court_id, ...state } = data;
                        courts[court_id] = state;
                        render();
                    }
                } catch (e) { console.error('SSE parse error:', e); }
            });

            eventSource.onerror = () => {
                eventSource.close();
                setTimeout(connectSSE, 5000);
            };
        }

        async function loadSnapshot() {
            try {
                const resp = await fetch('/api/snapshot');
                const data = await resp.json();
                const c = data.courts || data;
                Object.keys(c).forEach(id => { courts[id] = c[id]; });
            } catch (e) { console.error('Snapshot load failed:', e); }
        }

        async function loadOverlaySettings() {
            try {
                const resp = await fetch('/api/overlay/settings');
                if (resp.ok) overlaySettings = await resp.json();
            } catch (e) { /* defaults */ }
        }

        async function init() {
            await Promise.all([loadSnapshot(), loadOverlaySettings()]);
            render();
            connectSSE();
            setInterval(async () => {
                await loadOverlaySettings();
                render();
            }, SETTINGS_POLL_MS);
        }

        init();
        window.addEventListener('beforeunload', () => { if (eventSource) eventSource.close(); });
    </script>
</body>
</html>
