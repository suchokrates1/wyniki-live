<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Score Overlay</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: transparent;
            overflow: hidden;
            color: white;
        }
        .layout {
            position: fixed; width: 1920px; height: 1080px;
            transform-origin: top left;
            transition: opacity 1s ease;
        }
        .layout.auto-hidden { opacity: 0; pointer-events: none; }
        .element-wrapper {
            position: absolute;
            transition: left 0.4s ease, top 0.4s ease, width 0.4s ease, opacity 0.5s ease;
        }
        .element-wrapper.el-hidden {
            opacity: 0; pointer-events: none; transform: translateY(-30px);
        }
        .court-label-bar {
            text-align: center; font-weight: 700; text-transform: uppercase;
            letter-spacing: 1.5px; padding: 4px 12px;
            border-radius: 6px 6px 0 0; white-space: nowrap;
        }
        .label-below .court-label-bar { border-radius: 0 0 6px 6px; }
        .scoreboard {
            display: flex;
            background: linear-gradient(135deg, rgba(26,35,126,0.95), rgba(13,71,161,0.95));
            border-radius: 12px; padding: 14px 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.15);
            transition: opacity 0.5s ease, transform 0.5s ease;
            overflow: hidden;
        }
        .scoreboard.small { padding: 8px 12px; }
        .scoreboard.match-inactive .players-area { opacity: 0.4; }
        .logo-area {
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            margin-right: 14px; overflow: hidden; border-radius: 6px;
        }
        .logo-area img { width: 100%; height: 100%; object-fit: cover; border-radius: 6px; }
        .players-area { flex: 1; min-width: 0; }
        .player-row { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .scoreboard.small .player-row { gap: 6px; margin-bottom: 3px; }
        .serve-dot {
            width: 8px; height: 8px; border-radius: 50%;
            background: #4CAF50; flex-shrink: 0; opacity: 0;
            transition: opacity 0.3s ease;
        }
        .player-row.serving .serve-dot { opacity: 1; }
        .scoreboard.small .serve-dot { width: 6px; height: 6px; }
        .flag {
            width: 30px; height: 22px; object-fit: cover;
            border-radius: 3px; box-shadow: 0 1px 4px rgba(0,0,0,0.3); flex-shrink: 0;
        }
        .scoreboard.small .flag { width: 20px; height: 15px; }
        .player-name {
            flex: 1; font-size: 17px; font-weight: 600;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis; min-width: 0;
        }
        .scoreboard.small .player-name { font-size: 12px; }
        .scores { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }
        .scoreboard.small .scores { gap: 3px; }
        .score {
            min-width: 32px; text-align: center; font-size: 20px;
            font-weight: 700; padding: 3px 6px;
            background: rgba(0,0,0,0.3); border-radius: 5px;
        }
        .scoreboard.small .score { min-width: 22px; font-size: 13px; padding: 2px 4px; }
        .score.points { background: rgba(255,255,255,0.15); min-width: 38px; }
        .scoreboard.small .score.points { min-width: 26px; }
        .score.tiebreak { background: rgba(76,175,80,0.5); }
        .stats-panel {
            width: 100%;
            background: linear-gradient(135deg, rgba(30,30,30,0.95), rgba(50,50,50,0.92));
            border-radius: 12px; padding: 16px 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.12);
        }
        .stats-title {
            text-align: center; font-size: 12px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1.5px;
            margin-bottom: 12px; opacity: 0.7;
        }
        .stats-header {
            display: grid; grid-template-columns: 1fr 60px 60px;
            gap: 4px; margin-bottom: 6px; padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        .stats-header .player-col {
            text-align: center; font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .stats-row {
            display: grid; grid-template-columns: 1fr 60px 60px;
            gap: 4px; padding: 4px 0;
        }
        .stats-row:nth-child(even) { background: rgba(255,255,255,0.04); border-radius: 4px; }
        .stat-label { font-size: 13px; font-weight: 500; opacity: 0.9; }
        .stat-value { text-align: center; font-size: 14px; font-weight: 700; }
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
    const overlayId = window.location.pathname.split('/').pop() || '1';
    const SETTINGS_POLL_MS = 2000;
    const ALL_COURT_IDS = ['1','2','3','4'];
    let courts = {};
    let settings = { tournament_logo: null, tournament_name: '', overlays: {} };
    let eventSource = null;

    function getPreset() {
        return settings.overlays?.[overlayId] || { name: '', auto_hide: false, elements: [] };
    }

    function renderScoreboard(el) {
        const cid = el.court_id;
        const court = courts[cid] || {};
        const pA = court.A || {}, pB = court.B || {};
        const active = court.match_status?.active || false;
        const isSmall = el.size === 'small';
        const sizeClass = isSmall ? 'small' : '';
        const inactiveClass = active ? '' : 'match-inactive';
        const curSet = court.current_set || 1;
        const sets = [];
        for (let s = 1; s <= 3; s++) {
            const a = pA['set'+s], b = pB['set'+s];
            if (s <= curSet || (a > 0 || b > 0)) sets.push({ a: a||0, b: b||0 });
        }
        if (!sets.length) sets.push({ a:0, b:0 });
        const isTie = court.tie?.visible || false;
        const ptA = isTie ? (court.tie?.A||0) : (pA.points||'0');
        const ptB = isTie ? (court.tie?.B||0) : (pB.points||'0');
        const ptCls = isTie ? 'score points tiebreak' : 'score points';
        const logo = settings.tournament_logo;
        const showLogo = el.show_logo && el.size === 'large' && logo;
        const logoH = 80;
        const logoHtml = showLogo
            ? '<div class="logo-area" style="width:'+logoH+'px;height:'+logoH+'px;"><img src="'+logo+'" alt=""></div>'
            : '';
        function pRow(p, serve, side) {
            return '<div class="player-row '+(court.serve===serve?'serving':'')+'">'
                +'<div class="serve-dot"></div>'
                +(p.flag_url ? '<img src="'+p.flag_url+'" alt="'+(p.flag_code||'')+'" class="flag" onerror="this.style.display=\'none\'">' : '<div style="width:0"></div>')
                +'<div class="player-name">'+(p.surname||p.full_name||'\u2014')+'</div>'
                +'<div class="scores">'
                +sets.map(function(s){return '<div class="score">'+s[side]+'</div>';}).join('')
                +(active ? '<div class="'+ptCls+'">'+(side==='a'?ptA:ptB)+'</div>' : '')
                +'</div></div>';
        }
        return '<div class="scoreboard '+sizeClass+' '+inactiveClass+'">'
            +logoHtml
            +'<div class="players-area">'
            +pRow(pA,'A','a')
            +pRow(pB,'B','b')
            +'</div></div>';
    }

    function renderStats(el) {
        var court = courts[el.court_id] || {};
        var active = court.match_status?.active || false;
        if (!active) return '';
        var st = court.stats || {};
        var pA = court.A || {}, pB = court.B || {};
        var nA = pA.surname||pA.full_name||'A';
        var nB = pB.surname||pB.full_name||'B';
        var sA = st.player_a||{}, sB = st.player_b||{};
        var rows = [
            {l:'Asy', a:sA.aces!=null?sA.aces:'\u2014', b:sB.aces!=null?sB.aces:'\u2014'},
            {l:'Podw. b\u0142\u0119dy', a:sA.double_faults!=null?sA.double_faults:'\u2014', b:sB.double_faults!=null?sB.double_faults:'\u2014'},
            {l:'Winnery', a:sA.winners!=null?sA.winners:'\u2014', b:sB.winners!=null?sB.winners:'\u2014'},
            {l:'B\u0142. niewymuszone', a:sA.unforced_errors!=null?sA.unforced_errors:'\u2014', b:sB.unforced_errors!=null?sB.unforced_errors:'\u2014'},
            {l:'1. serwis %', a:sA.first_serve_pct!=null?sA.first_serve_pct+'%':'\u2014', b:sB.first_serve_pct!=null?sB.first_serve_pct+'%':'\u2014'},
        ];
        return '<div class="stats-panel">'
            +'<div class="stats-title">Statystyki</div>'
            +'<div class="stats-header"><div></div><div class="player-col">'+nA+'</div><div class="player-col">'+nB+'</div></div>'
            +rows.map(function(r){return '<div class="stats-row"><div class="stat-label">'+r.l+'</div><div class="stat-value">'+r.a+'</div><div class="stat-value">'+r.b+'</div></div>';}).join('')
            +'</div>';
    }

    function renderLabel(el) {
        if (!el.label_text || el.label_position === 'none') return '';
        var bg = 'rgba(0,0,0,'+(el.label_bg_opacity != null ? el.label_bg_opacity : 0.7)+')';
        var fs = el.label_font_size || 13;
        var gap = el.label_gap || 4;
        var pos = el.label_position || 'above';
        var marginProp = pos==='above' ? 'margin-bottom' : 'margin-top';
        return '<div class="court-label-bar" style="background:'+bg+';font-size:'+fs+'px;'+marginProp+':'+gap+'px;color:white;">'+el.label_text+'</div>';
    }

    function render() {
        var preset = getPreset();
        var anyActive = ALL_COURT_IDS.some(function(id){return courts[id]?.match_status?.active;});
        var autoHidden = preset.auto_hide && !anyActive;
        var sx = window.innerWidth / 1920;
        var sy = window.innerHeight / 1080;
        var scale = Math.min(sx, sy);
        var elems = preset.elements || [];
        var html = elems.map(function(el) {
            var hidden = el.visible === false ? 'el-hidden' : '';
            var style = 'left:'+el.x+'px;top:'+el.y+'px;width:'+el.w+'px;';
            if (el.type === 'stats') {
                return '<div class="element-wrapper '+hidden+'" style="'+style+'">'+renderStats(el)+'</div>';
            }
            var labelAbove = el.label_position !== 'below' ? renderLabel(el) : '';
            var labelBelow = el.label_position === 'below' ? renderLabel(el) : '';
            var wrapClass = el.label_position === 'below' ? 'label-below' : '';
            return '<div class="element-wrapper '+hidden+' '+wrapClass+'" style="'+style+'">'
                +labelAbove+renderScoreboard(el)+labelBelow+'</div>';
        }).join('');
        document.getElementById('app').innerHTML =
            '<div class="layout '+(autoHidden?'auto-hidden':'')+'" style="transform:scale('+scale+')">'+html+'</div>';
    }

    function connectSSE() {
        if (eventSource) eventSource.close();
        eventSource = new EventSource('/api/stream');
        eventSource.addEventListener('court_update', function(e) {
            try {
                var d = JSON.parse(e.data);
                if (d.court_id) {
                    var cid = d.court_id;
                    delete d.court_id;
                    courts[cid] = d;
                    render();
                }
            } catch(err) { console.error('SSE parse:', err); }
        });
        eventSource.onerror = function() { eventSource.close(); setTimeout(connectSSE, 5000); };
    }

    async function loadSnapshot() {
        try {
            var r = await fetch('/api/snapshot');
            var d = await r.json();
            var c = d.courts || d;
            Object.keys(c).forEach(function(id){ courts[id] = c[id]; });
        } catch(e) { console.error('Snapshot:', e); }
    }

    async function loadSettings() {
        try {
            var r = await fetch('/api/overlay/settings');
            if (r.ok) settings = await r.json();
        } catch(e) { /* defaults */ }
    }

    async function init() {
        await Promise.all([loadSnapshot(), loadSettings()]);
        render();
        connectSSE();
        setInterval(async function() { await loadSettings(); render(); }, SETTINGS_POLL_MS);
        window.addEventListener('resize', render);
    }
    init();
    window.addEventListener('beforeunload', function() { if (eventSource) eventSource.close(); });
    </script>
</body>
</html>