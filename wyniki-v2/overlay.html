<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Score Overlay</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: transparent;
            overflow: hidden;
            color: white;
        }
        .layout {
            position: fixed; width: 1920px; height: 1080px;
            transform-origin: top left;
            transition: opacity 1s ease;
        }
        .layout.auto-hidden { opacity: 0; pointer-events: none; }
        .element-wrapper {
            position: absolute;
            transition: left 0.4s ease, top 0.4s ease, width 0.4s ease, opacity 0.5s ease;
        }
        .element-wrapper.el-hidden {
            opacity: 0; pointer-events: none; transform: translateY(-30px);
        }

        /* ---- Court label bar ---- */
        .court-label-bar {
            text-align: center; font-weight: 700; text-transform: uppercase;
            letter-spacing: 0.1em; padding: 6px 16px;
            white-space: nowrap; color: white;
        }

        /* ---- Dark grid scoreboard (matches main page) ---- */
        .sb-wrap {
            display: flex; align-items: stretch; gap: 10px;
            transition: opacity 0.5s ease;
        }
        .sb-wrap.match-inactive .score-table { opacity: 0.4; }

        /* Height fill (when H is set) */
        .element-wrapper.has-h { display: flex; flex-direction: column; }
        .sb-wrap.h-fill { flex: 1; min-height: 0; }
        .sb-wrap.h-fill .score-table { flex: 1; grid-template-rows: 1fr 1fr; }

        /* Logo area (optional, left of table) – auto-matches scoreboard height, keeps square */
        .logo-area {
            flex-shrink: 0; display: flex; align-items: center; justify-content: center;
            overflow: hidden; border-radius: 8px;
            align-self: stretch; aspect-ratio: 1;
        }
        .logo-area img { width: 100%; height: 100%; object-fit: cover; border-radius: 8px; }
        .logo-ph {
            display: flex; align-items: center; justify-content: center;
            width: 100%; height: 100%; background: rgba(255,255,255,0.1);
            border-radius: 8px; font-size: 28px;
        }

        /* Score grid table */
        .score-table {
            flex: 1; min-width: 0;
            display: grid; gap: 0;
            border-radius: 14px; overflow: hidden;
            background: linear-gradient(180deg, #1d1d1d 0%, #090909 100%);
            box-shadow: 0 12px 24px rgba(0,0,0,0.35);
            border: 1px solid rgba(0,0,0,0.8);
        }
        .score-row {
            display: grid; align-items: stretch; color: #fdfdfd;
        }
        .score-row + .score-row {
            border-top: 1px solid rgba(255,255,255,0.08);
        }

        /* Player cell (left side) */
        .player-cell {
            display: flex; align-items: center; gap: 8px;
            padding: 4px 10px;
            background: linear-gradient(90deg, rgba(255,255,255,0.06) 0%, rgba(0,0,0,0) 100%);
            font-size: 18px; font-weight: 700; letter-spacing: 0.6px; text-transform: uppercase;
            border-right: 1px solid rgba(0,0,0,0.65);
            text-shadow: 0 1px 0 rgba(0,0,0,0.6);
            white-space: nowrap; overflow: hidden;
        }
        .score-row.side-b .player-cell {
            background: linear-gradient(90deg, rgba(255,255,255,0.03) 0%, rgba(0,0,0,0) 100%);
        }
        .player-cell .player-name {
            flex: 1; min-width: 0; overflow: hidden; color: #fefefe;
            white-space: nowrap;
        }

        /* Flag */
        .player-flag {
            width: 32px; height: 20px; flex-shrink: 0;
            display: inline-flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; border-radius: 3px;
            background: #2f2f2f; color: #111; text-transform: uppercase;
            background-size: cover; background-position: center;
            box-shadow: 0 0 0 1px rgba(255,255,255,0.45);
        }
        .player-flag.has-image { color: transparent; }

        /* Serve indicator */
        .serve-indicator {
            display: inline-flex; align-items: center; justify-content: center;
            flex-shrink: 0; margin-left: auto;
            filter: drop-shadow(0 0 4px rgba(53,196,106,.6));
            animation: serve-pulse 2s ease-in-out infinite;
        }
        .serve-indicator img {
            width: 18px; height: 18px;
        }
        @keyframes serve-pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50%      { opacity: .7; transform: scale(.88); }
        }

        /* Metric cells (score columns) */
        .metric-cell {
            display: flex; align-items: center; justify-content: center;
            padding: 4px 0; font-size: 28px; font-weight: 700;
            letter-spacing: 0.5px;
            text-shadow: 0 1px 0 rgba(0,0,0,0.45);
            transition: background-color 0.3s ease, color 0.3s ease;
            min-width: 1.5em;
        }
        .metric-cell + .metric-cell {
            border-left: 1px solid rgba(0,0,0,0.6);
        }

        /* Points column - dark */
        .metric-cell.pts {
            background: linear-gradient(180deg, #141414 0%, #050505 100%);
            color: #fafafa;
            min-width: 2.2em;
        }
        /* Points in tiebreak - golden */
        .metric-cell.pts.is-tiebreak {
            background: linear-gradient(180deg, #ffe6a7 0%, #f3c34a 100%);
            color: #261200; text-shadow: none;
        }
        /* Set scores - orange */
        .metric-cell.set {
            background: linear-gradient(180deg, #ff7a1c 0%, #d64900 100%);
            color: #fff9f2;
        }
        /* Active set - glowing border */
        .metric-cell.set.is-active {
            box-shadow: inset 0 0 0 2px rgba(255,255,255,0.35);
        }

        /* ---- Stats panel ---- */
        .stats-panel {
            width: 100%;
            background: linear-gradient(135deg, rgba(30,30,30,0.95), rgba(50,50,50,0.92));
            border-radius: 12px; padding: 16px 20px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.5);
            border: 2px solid rgba(255,255,255,0.12);
        }
        .stats-title {
            text-align: center; font-size: 12px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1.5px;
            margin-bottom: 12px; opacity: 0.7;
        }
        .stats-header {
            display: grid; grid-template-columns: 1fr 60px 60px;
            gap: 4px; margin-bottom: 6px; padding-bottom: 6px;
            border-bottom: 1px solid rgba(255,255,255,0.15);
        }
        .stats-header .player-col {
            text-align: center; font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }
        .stats-row {
            display: grid; grid-template-columns: 1fr 60px 60px;
            gap: 4px; padding: 4px 0;
        }
        .stats-row:nth-child(even) { background: rgba(255,255,255,0.04); border-radius: 4px; }
        .stat-label { font-size: 13px; font-weight: 500; opacity: 0.9; }
        .stat-value { text-align: center; font-size: 14px; font-weight: 700; }
    </style>
</head>
<body>
    <div id="app"></div>
    <script>
    const overlayId = window.location.pathname.split('/').pop() || '1';
    const SETTINGS_POLL_MS = 2000;
    const ALL_COURT_IDS = ['1','2','3','4'];

    function codeToFlag(code) {
        if (!code || code.length < 2) return '';
        return 'https://flagcdn.com/w40/' + code.toLowerCase().slice(0, 2) + '.png';
    }
    let courts = {};
    let settings = { tournament_logo: null, tournament_name: '', overlays: {} };
    let eventSource = null;

    function getPreset() {
        return settings.overlays?.[overlayId] || { name: '', auto_hide: false, elements: [] };
    }

    function renderScoreboard(el) {
        const cid = el.court_id;
        const court = courts[cid] || {};
        const pA = court.A || {}, pB = court.B || {};
        const active = court.match_status?.active || false;
        const inactiveClass = active ? '' : 'match-inactive';
        const curSet = court.current_set || 1;
        const bgOpacity = el.bg_opacity != null ? el.bg_opacity : 0.95;
        const logoSize = el.logo_size || 60;
        const sets = [];
        for (let s = 1; s <= 3; s++) {
            const a = pA['set'+s], b = pB['set'+s];
            if (s <= curSet || a > 0 || b > 0) sets.push({ idx: s, a: a||0, b: b||0 });
        }
        // Always show at least 2 set columns
        while (sets.length < 2) sets.push({ idx: sets.length + 1, a: 0, b: 0 });
        const isTie = court.tie?.visible || false;
        const ptA = isTie ? (court.tie?.A||0) : (pA.points||'0');
        const ptB = isTie ? (court.tie?.B||0) : (pB.points||'0');
        const tbCls = isTie ? ' is-tiebreak' : '';
        const logo = settings.tournament_logo;
        const showLogo = el.show_logo;

        // Logo HTML (auto-sized to scoreboard height, square)
        var logoHtml = '';
        if (showLogo) {
            if (logo) {
                logoHtml = '<div class="logo-area"><img src="'+logo+'" alt=""></div>';
            } else {
                logoHtml = '<div class="logo-area"><div class="logo-ph">\uD83C\uDFBE</div></div>';
            }
        }

        // Grid template: player-cell | points | set1 | set2 | [set3]
        var nCols = 1 + 1 + sets.length; // player + points + sets
        var gridCols = 'grid-template-columns: 1fr auto repeat('+sets.length+', auto);';

        function pRow(p, serveKey, sideClass) {
            var isServing = court.serve === serveKey;
            var flagHtml = '';
            var flagUrl = p.flag_url || (p.flag_code ? codeToFlag(p.flag_code) : '');
            if (flagUrl) {
                flagHtml = '<span class="player-flag has-image" style="background-image:url('+flagUrl+')"></span>';
            }
            var serveHtml = isServing ? '<span class="serve-indicator"><img src="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 36 36%27%3E%3Ccircle cx=%2718%27 cy=%2718%27 r=%2717%27 fill=%27%23C6E953%27/%3E%3Ccircle cx=%2718%27 cy=%2718%27 r=%2717%27 fill=%27none%27 stroke=%27%23fff%27 stroke-width=%272%27/%3E%3Cpath d=%27M5 11c4 8 14 14 26 6%27 fill=%27none%27 stroke=%27%23fff%27 stroke-width=%272%27/%3E%3Cpath d=%27M5 25c6-8 16-14 26-6%27 fill=%27none%27 stroke=%27%23fff%27 stroke-width=%272%27/%3E%3C/svg%3E" alt="serve"></span>' : '';
            var dName = p.surname||p.full_name||'\u2014';
            var playerCell = '<div class="player-cell">'+flagHtml
                +'<span class="player-name" data-full="'+dName.replace(/"/g,'&quot;')+'">'+dName+'</span>'
                +serveHtml+'</div>';

            // Points cell
            var ptsVal = serveKey === 'A' ? ptA : ptB;
            var ptsCell = active ? '<div class="metric-cell pts'+tbCls+'">'+ptsVal+'</div>' : '<div class="metric-cell pts">\u2014</div>';

            // Set cells
            var setCells = sets.map(function(s) {
                var val = serveKey === 'A' ? s.a : s.b;
                var activeCls = s.idx === curSet ? ' is-active' : '';
                return '<div class="metric-cell set'+activeCls+'">'+val+'</div>';
            }).join('');

            return '<div class="score-row '+sideClass+'" style="'+gridCols+'">'+playerCell+ptsCell+setCells+'</div>';
        }

        var opacityStyle = bgOpacity < 1 ? 'opacity:'+bgOpacity+';' : '';
        var hFill = el.h ? ' h-fill' : '';
        return '<div class="sb-wrap '+inactiveClass+hFill+'">'
            +logoHtml
            +'<div class="score-table" style="'+opacityStyle+'">'
            +pRow(pA, 'A', 'side-a')
            +pRow(pB, 'B', 'side-b')
            +'</div></div>';
    }

    function renderStats(el) {
        var court = courts[el.court_id] || {};
        var active = court.match_status?.active || false;
        if (!active) return '';
        var st = court.stats || {};
        var pA = court.A || {}, pB = court.B || {};
        var nA = pA.surname||pA.full_name||'A';
        var nB = pB.surname||pB.full_name||'B';
        var sA = st.player_a||{}, sB = st.player_b||{};
        var rows = [
            {l:'Asy', a:sA.aces!=null?sA.aces:'\u2014', b:sB.aces!=null?sB.aces:'\u2014'},
            {l:'Podw. b\u0142\u0119dy', a:sA.double_faults!=null?sA.double_faults:'\u2014', b:sB.double_faults!=null?sB.double_faults:'\u2014'},
            {l:'Winnery', a:sA.winners!=null?sA.winners:'\u2014', b:sB.winners!=null?sB.winners:'\u2014'},
            {l:'B\u0142. niewymuszone', a:sA.unforced_errors!=null?sA.unforced_errors:'\u2014', b:sB.unforced_errors!=null?sB.unforced_errors:'\u2014'},
            {l:'1. serwis %', a:sA.first_serve_pct!=null?sA.first_serve_pct+'%':'\u2014', b:sB.first_serve_pct!=null?sB.first_serve_pct+'%':'\u2014'},
        ];
        return '<div class="stats-panel">'
            +'<div class="stats-title">Statystyki</div>'
            +'<div class="stats-header"><div></div><div class="player-col">'+nA+'</div><div class="player-col">'+nB+'</div></div>'
            +rows.map(function(r){return '<div class="stats-row"><div class="stat-label">'+r.l+'</div><div class="stat-value">'+r.a+'</div><div class="stat-value">'+r.b+'</div></div>';}).join('')
            +'</div>';
    }

    function renderLabel(el) {
        if (!el.label_text || el.label_position === 'none') return '';
        var bg = 'rgba(0,0,0,'+(el.label_bg_opacity != null ? el.label_bg_opacity : 0.7)+')';
        var fs = el.label_font_size || 14;
        var gap = el.label_gap != null ? el.label_gap : 4;
        var pos = el.label_position || 'above';
        var marginProp = pos==='above' ? 'margin-bottom' : 'margin-top';
        var radius = pos==='above' ? 'border-radius:6px 6px 0 0;' : 'border-radius:0 0 6px 6px;';
        return '<div class="court-label-bar" style="background:'+bg+';font-size:'+fs+'px;'+marginProp+':'+gap+'px;'+radius+'color:white;">'+el.label_text+'</div>';
    }

    function render() {
        var preset = getPreset();
        var anyActive = ALL_COURT_IDS.some(function(id){return courts[id]?.match_status?.active;});
        var autoHidden = preset.auto_hide && !anyActive;
        var sx = window.innerWidth / 1920;
        var sy = window.innerHeight / 1080;
        var scale = Math.min(sx, sy);
        var elems = preset.elements || [];

        // Apply top-bar grid positioning (mirrors admin.js logic)
        if (preset.top_bar?.enabled) {
            var topEls = elems.filter(function(e){ return e.zone === 'top'; });
            if (topEls.length > 0) {
                var cols = preset.top_bar.columns || 3;
                var mx = preset.top_bar.margin_x || 0;
                var mt = preset.top_bar.margin_top || 0;
                var gap = preset.top_bar.gap || 10;
                var totalW = 1920 - 2 * mx;
                var usable = topEls.length > cols ? cols : topEls.length;
                var colW = Math.round((totalW - (usable - 1) * gap) / usable);
                var refH = topEls[0].h || null;
                topEls.forEach(function(el, i) {
                    if (i >= cols) return;
                    el.x = Math.round(mx + i * (colW + gap));
                    el.y = mt;
                    el.w = colW;
                    if (refH) el.h = refH;
                });
            }
        }

        var html = elems.map(function(el) {
            var hidden = el.visible === false ? 'el-hidden' : '';
            var style = 'left:'+el.x+'px;top:'+el.y+'px;width:'+el.w+'px;';
            if (el.h) style += 'height:'+el.h+'px;';
            var hClass = el.h ? ' has-h' : '';
            if (el.type === 'stats') {
                return '<div class="element-wrapper '+hidden+hClass+'" style="'+style+'">'+renderStats(el)+'</div>';
            }
            var pos = el.label_position || 'above';
            var labelAbove = pos === 'above' ? renderLabel(el) : '';
            var labelBelow = pos === 'below' ? renderLabel(el) : '';
            if (el.h) {
                var sbWrap = '<div style="flex:1;min-height:0;display:flex;flex-direction:column;">'+renderScoreboard(el)+'</div>';
                return '<div class="element-wrapper '+hidden+' has-h" style="'+style+'">'
                    +labelAbove+sbWrap+labelBelow+'</div>';
            }
            var wrapClass = pos === 'below' ? 'label-below' : '';
            return '<div class="element-wrapper '+hidden+' '+wrapClass+'" style="'+style+'">'
                +labelAbove+renderScoreboard(el)+labelBelow+'</div>';
        }).join('');
        document.getElementById('app').innerHTML =
            '<div class="layout '+(autoHidden?'auto-hidden':'')+'" style="transform:scale('+scale+')">'+html+'</div>';
    }

    function connectSSE() {
        if (eventSource) eventSource.close();
        eventSource = new EventSource('/api/stream');
        eventSource.addEventListener('court_update', function(e) {
            try {
                var d = JSON.parse(e.data);
                if (d.court_id) {
                    var cid = d.court_id;
                    delete d.court_id;
                    courts[cid] = d;
                    render();
                    requestAnimationFrame(fitPlayerNames);
                }
            } catch(err) { console.error('SSE parse:', err); }
        });
        eventSource.onerror = function() { eventSource.close(); setTimeout(connectSSE, 5000); };
    }

    async function loadSnapshot() {
        try {
            var r = await fetch('/api/snapshot');
            var d = await r.json();
            var c = d.courts || d;
            Object.keys(c).forEach(function(id){ courts[id] = c[id]; });
        } catch(e) { console.error('Snapshot:', e); }
    }

    async function loadSettings() {
        try {
            var r = await fetch('/api/overlay/settings');
            if (r.ok) settings = await r.json();
        } catch(e) { /* defaults */ }
    }

    function abbreviateName(name) {
        var parts = name.trim().split(/\s+/);
        if (parts.length < 2) return name;
        var surname = parts[parts.length - 1];
        var initials = parts.slice(0, -1).map(function(p) { return p.charAt(0).toUpperCase() + '.'; }).join(' ');
        return initials + ' ' + surname;
    }

    function fitPlayerNames() {
        document.querySelectorAll('.player-name').forEach(function(el) {
            el.style.transform = '';
            el.style.overflow = 'hidden';
            var fullName = el.getAttribute('data-full') || el.textContent;
            el.textContent = fullName;
            var sw = el.scrollWidth;
            var cw = el.clientWidth;
            if (sw <= cw + 1) return;
            var scale = cw / sw;
            // Moderate overflow – just compress
            if (scale >= 0.75) {
                el.style.overflow = 'visible';
                el.style.transform = 'scaleX(' + scale + ')';
                el.style.transformOrigin = 'left center';
                return;
            }
            // Heavy overflow – abbreviate first name(s) to initials
            var abbr = abbreviateName(fullName);
            if (abbr !== fullName) {
                el.textContent = abbr;
                sw = el.scrollWidth;
            }
            if (sw > cw + 1) {
                scale = cw / sw;
                el.style.overflow = 'visible';
                el.style.transform = 'scaleX(' + Math.max(scale, 0.55) + ')';
                el.style.transformOrigin = 'left center';
            }
        });
    }

    async function init() {
        await Promise.all([loadSnapshot(), loadSettings()]);
        render();
        requestAnimationFrame(fitPlayerNames);
        connectSSE();
        setInterval(async function() { await loadSettings(); render(); requestAnimationFrame(fitPlayerNames); }, SETTINGS_POLL_MS);
        window.addEventListener('resize', function() { render(); requestAnimationFrame(fitPlayerNames); });
    }
    init();
    window.addEventListener('beforeunload', function() { if (eventSource) eventSource.close(); });
    </script>
</body>
</html>