<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tennis Score Overlay</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            background: transparent;
            overflow: hidden;
            color: white;
        }

        /* ========== SCOREBOARD ========== */
        .scoreboard {
            background: linear-gradient(135deg, rgba(26, 35, 126, 0.95), rgba(13, 71, 161, 0.95));
            border-radius: 12px;
            padding: 14px 18px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.15);
            transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .scoreboard.small {
            padding: 8px 12px;
        }

        .scoreboard.hidden-slide-left {
            opacity: 0;
            transform: translateX(-120%);
            pointer-events: none;
        }

        .scoreboard.hidden-slide-up {
            opacity: 0;
            transform: translateY(-120%);
            pointer-events: none;
        }

        .scoreboard.hidden-slide-down {
            opacity: 0;
            transform: translateY(120%);
            pointer-events: none;
        }

        .court-label {
            text-align: center;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 8px;
            opacity: 0.85;
        }

        .scoreboard.small .court-label {
            font-size: 10px;
            margin-bottom: 4px;
            letter-spacing: 1px;
        }

        .player-row {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
        }

        .scoreboard.small .player-row {
            gap: 6px;
            margin-bottom: 3px;
        }

        .flag {
            width: 30px;
            height: 22px;
            object-fit: cover;
            border-radius: 3px;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.3);
            flex-shrink: 0;
        }

        .scoreboard.small .flag {
            width: 20px;
            height: 15px;
        }

        .serve-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            flex-shrink: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .player-row.serving .serve-dot {
            opacity: 1;
        }

        .scoreboard.small .serve-dot {
            width: 6px;
            height: 6px;
        }

        .player-name {
            flex: 1;
            font-size: 17px;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            min-width: 0;
        }

        .scoreboard.small .player-name {
            font-size: 12px;
        }

        .scores {
            display: flex;
            gap: 6px;
            align-items: center;
            flex-shrink: 0;
        }

        .scoreboard.small .scores {
            gap: 3px;
        }

        .score {
            min-width: 32px;
            text-align: center;
            font-size: 20px;
            font-weight: 700;
            padding: 3px 6px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 5px;
        }

        .scoreboard.small .score {
            min-width: 22px;
            font-size: 13px;
            padding: 2px 4px;
            border-radius: 4px;
        }

        .score.points {
            background: rgba(255, 255, 255, 0.15);
            min-width: 38px;
        }

        .scoreboard.small .score.points {
            min-width: 26px;
        }

        .score.tiebreak {
            background: rgba(76, 175, 80, 0.5);
        }

        .match-inactive .player-row {
            opacity: 0.4;
        }

        /* ========== LAYOUT ========== */
        .layout {
            position: fixed;
            width: 100vw;
            height: 100vh;
            transition: opacity 1s ease;
        }

        .main-court {
            position: absolute;
            bottom: 24px;
            left: 24px;
            width: 420px;
        }

        .other-courts {
            position: absolute;
            top: 20px;
            left: 20px;
            display: flex;
            gap: 12px;
        }

        .other-courts .scoreboard {
            width: 260px;
        }

        /* ========== STATS PANEL ========== */
        .stats-panel {
            position: absolute;
            bottom: 24px;
            left: 460px;
            width: 360px;
            background: linear-gradient(135deg, rgba(30, 30, 30, 0.95), rgba(50, 50, 50, 0.92));
            border-radius: 12px;
            padding: 16px 20px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
            border: 2px solid rgba(255, 255, 255, 0.12);
            transition: opacity 0.5s ease, transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .stats-panel.hidden {
            opacity: 0;
            transform: translateX(-40px);
            pointer-events: none;
        }

        .stats-title {
            text-align: center;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
            opacity: 0.7;
        }

        .stats-header {
            display: grid;
            grid-template-columns: 1fr 60px 60px;
            gap: 4px;
            margin-bottom: 6px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.15);
        }

        .stats-header .player-col {
            text-align: center;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            opacity: 0.7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .stats-row {
            display: grid;
            grid-template-columns: 1fr 60px 60px;
            gap: 4px;
            padding: 4px 0;
        }

        .stats-row:nth-child(even) {
            background: rgba(255, 255, 255, 0.04);
            border-radius: 4px;
        }

        .stat-label {
            font-size: 13px;
            font-weight: 500;
            opacity: 0.9;
        }

        .stat-value {
            text-align: center;
            font-size: 14px;
            font-weight: 700;
        }

        /* ========== AUTO-HIDE ========== */
        .layout.auto-hidden {
            opacity: 0;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div id="app"></div>

    <script>
        // ============================================================
        // CONFIG
        // ============================================================
        const pathParts = window.location.pathname.split('/');
        const focusCourtId = pathParts[pathParts.length - 1];
        const allCourtIds = ['1', '2', '3', '4'];
        const SETTINGS_POLL_MS = 2000;

        // ============================================================
        // STATE
        // ============================================================
        let courts = {};
        let overlaySettings = {
            courts_visible: { '1': true, '2': true, '3': true, '4': true },
            auto_hide: false,
            show_stats: false,
        };
        let eventSource = null;

        // ============================================================
        // SCOREBOARD RENDERER
        // ============================================================
        function renderScoreboard(kortId, isSmall = false, label = '') {
            const court = courts[kortId] || {};
            const playerA = court.A || {};
            const playerB = court.B || {};
            const matchActive = court.match_status?.active || false;
            const isVisible = overlaySettings.courts_visible[kortId] !== false;

            const sizeClass = isSmall ? 'small' : '';
            const activeClass = matchActive ? '' : 'match-inactive';
            const slideClass = isVisible
                ? ''
                : (isSmall ? 'hidden-slide-up' : 'hidden-slide-left');
            const labelText = label || `Kort ${kortId}`;

            // Show only played sets
            const currentSet = court.current_set || 1;
            const setScores = [];
            for (let s = 1; s <= 3; s++) {
                const aVal = playerA[`set${s}`];
                const bVal = playerB[`set${s}`];
                if (s <= currentSet || (aVal > 0 || bVal > 0)) {
                    setScores.push({ a: aVal || 0, b: bVal || 0 });
                }
            }
            if (setScores.length === 0) setScores.push({ a: 0, b: 0 });

            const isTiebreak = court.tie?.visible || false;
            const pointsA = isTiebreak ? (court.tie?.A || 0) : (playerA.points || '0');
            const pointsB = isTiebreak ? (court.tie?.B || 0) : (playerB.points || '0');
            const pointsClass = isTiebreak ? 'score points tiebreak' : 'score points';

            return `
                <div class="scoreboard ${sizeClass} ${activeClass} ${slideClass}" data-court="${kortId}">
                    <div class="court-label">${labelText}</div>
                    <div class="player-row ${court.serve === 'A' ? 'serving' : ''}">
                        <div class="serve-dot"></div>
                        ${playerA.flag_url ? `<img src="${playerA.flag_url}" alt="${playerA.flag_code || ''}" class="flag" onerror="this.style.display='none'">` : '<div style="width:0"></div>'}
                        <div class="player-name">${playerA.surname || playerA.full_name || '\u2014'}</div>
                        <div class="scores">
                            ${setScores.map(s => `<div class="score">${s.a}</div>`).join('')}
                            ${matchActive ? `<div class="${pointsClass}">${pointsA}</div>` : ''}
                        </div>
                    </div>
                    <div class="player-row ${court.serve === 'B' ? 'serving' : ''}">
                        <div class="serve-dot"></div>
                        ${playerB.flag_url ? `<img src="${playerB.flag_url}" alt="${playerB.flag_code || ''}" class="flag" onerror="this.style.display='none'">` : '<div style="width:0"></div>'}
                        <div class="player-name">${playerB.surname || playerB.full_name || '\u2014'}</div>
                        <div class="scores">
                            ${setScores.map(s => `<div class="score">${s.b}</div>`).join('')}
                            ${matchActive ? `<div class="${pointsClass}">${pointsB}</div>` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        // ============================================================
        // STATS PANEL
        // ============================================================
        function renderStatsPanel() {
            const court = courts[focusCourtId] || {};
            const matchActive = court.match_status?.active || false;
            const showStats = overlaySettings.show_stats && matchActive;

            // Stats come embedded in court state via SSE
            const st = court.stats || {};
            const playerA = court.A || {};
            const playerB = court.B || {};
            const nameA = playerA.surname || playerA.full_name || 'A';
            const nameB = playerB.surname || playerB.full_name || 'B';

            const statsA = st.player_a || {};
            const statsB = st.player_b || {};

            const rows = [
                { label: 'Asy', a: statsA.aces ?? '\u2014', b: statsB.aces ?? '\u2014' },
                { label: 'Podw\u00f3jne b\u0142\u0119dy', a: statsA.double_faults ?? '\u2014', b: statsB.double_faults ?? '\u2014' },
                { label: 'Winnery', a: statsA.winners ?? '\u2014', b: statsB.winners ?? '\u2014' },
                { label: 'B\u0142. niewymuszone', a: statsA.unforced_errors ?? '\u2014', b: statsB.unforced_errors ?? '\u2014' },
                { label: '1. serwis %', a: statsA.first_serve_pct != null ? statsA.first_serve_pct + '%' : '\u2014', b: statsB.first_serve_pct != null ? statsB.first_serve_pct + '%' : '\u2014' },
            ];

            return `
                <div class="stats-panel ${showStats ? '' : 'hidden'}">
                    <div class="stats-title">Statystyki</div>
                    <div class="stats-header">
                        <div></div>
                        <div class="player-col">${nameA}</div>
                        <div class="player-col">${nameB}</div>
                    </div>
                    ${rows.map(r => `
                        <div class="stats-row">
                            <div class="stat-label">${r.label}</div>
                            <div class="stat-value">${r.a}</div>
                            <div class="stat-value">${r.b}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // ============================================================
        // MAIN RENDER
        // ============================================================
        function render() {
            const app = document.getElementById('app');
            const otherCourts = allCourtIds.filter(id => id !== focusCourtId);

            // Auto-hide check
            const anyActive = allCourtIds.some(id => courts[id]?.match_status?.active);
            const autoHidden = overlaySettings.auto_hide && !anyActive;

            app.innerHTML = `
                <div class="layout ${autoHidden ? 'auto-hidden' : ''}">
                    <div class="other-courts">
                        ${otherCourts.map(id => renderScoreboard(id, true, `Kort ${id}`)).join('')}
                    </div>
                    <div class="main-court">
                        ${renderScoreboard(focusCourtId, false, `Kort ${focusCourtId}`)}
                    </div>
                    ${renderStatsPanel()}
                </div>
            `;
        }

        // ============================================================
        // SSE
        // ============================================================
        function connectSSE() {
            if (eventSource) eventSource.close();
            eventSource = new EventSource('/api/stream');

            eventSource.addEventListener('court_update', (event) => {
                try {
                    const data = JSON.parse(event.data);
                    const kortId = data.court_id;
                    if (kortId) {
                        const { court_id, ...state } = data;
                        courts[kortId] = state;
                        render();
                    }
                } catch (e) {
                    console.error('SSE parse error:', e);
                }
            });

            eventSource.onerror = () => {
                console.warn('SSE disconnected, reconnecting in 5s...');
                eventSource.close();
                setTimeout(connectSSE, 5000);
            };
        }

        // ============================================================
        // DATA LOADING
        // ============================================================
        async function loadSnapshot() {
            try {
                const resp = await fetch('/api/snapshot');
                const data = await resp.json();
                const c = data.courts || data;
                Object.keys(c).forEach(id => { courts[id] = c[id]; });
            } catch (e) {
                console.error('Snapshot load failed:', e);
            }
        }

        async function loadOverlaySettings() {
            try {
                const resp = await fetch('/api/overlay/settings');
                if (resp.ok) overlaySettings = await resp.json();
            } catch (e) { /* use defaults */ }
        }

        // ============================================================
        // INIT
        // ============================================================
        async function init() {
            await Promise.all([loadSnapshot(), loadOverlaySettings()]);
            render();
            connectSSE();

            // Poll overlay settings only
            setInterval(async () => {
                await loadOverlaySettings();
                render();
            }, SETTINGS_POLL_MS);
        }

        init();

        window.addEventListener('beforeunload', () => {
            if (eventSource) eventSource.close();
        });
    </script>
</body>
</html>
