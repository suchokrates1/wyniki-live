import{m}from"./main-DtaNp4HT.js";window.Alpine=m;m.data("adminApp",()=>({activeTab:"courts",courts:[],newCourtId:"",newCourtPin:"",editingCourt:null,editCourtId:"",tournaments:[],selectedTournament:null,newTournament:{name:"",start_date:"",end_date:""},players:[],newPlayer:{name:"",category:"",country:""},importText:"",overlaySettings:{tournament_logo:null,tournament_name:"",overlays:{}},currentOverlayId:"1",selectedElIdx:-1,canvasScale:1,dragging:null,courtData:{},_settingsSSE:null,addElCourtId:"1",cropImgSrc:"",cropZoom:100,_cropDragging:!1,_cropStart:{x:0,y:0},_cropOffset:{x:0,y:0},loading:{courts:!1,tournaments:!1,players:!1},toast:{show:!1,message:"",type:"info"},get filteredPlayers(){return this.players},init(){this.loadCourts(),this.loadTournaments(),this.loadOverlaySettings(),window.addEventListener("resize",()=>this.updateCanvasScale()),this.$nextTick(()=>this.updateCanvasScale())},showToast(t,e="info"){this.toast={show:!0,message:t,type:e},setTimeout(()=>{this.toast.show=!1},3e3)},async loadCourts(){this.loading.courts=!0;try{const t=await fetch("/admin/api/courts");if(!t.ok)throw new Error("Failed to load courts");this.courts=await t.json()}catch(t){console.error("Failed to load courts:",t),this.showToast("BÅ‚Ä…d Å‚adowania kortÃ³w","error")}finally{this.loading.courts=!1}},async refreshCourts(){await this.loadCourts(),this.showToast("Korty odÅ›wieÅ¼one","success")},async updateCourtPin(t,e){try{if(e&&(e.length!==4||!/^\d{4}$/.test(e))){this.showToast("PIN musi mieÄ‡ 4 cyfry","warning"),await this.loadCourts();return}if(!(await fetch(`/admin/api/courts/${t}/pin`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:e||null})})).ok)throw new Error("Failed to update PIN");this.showToast(`PIN dla kortu ${t} zaktualizowany`,"success"),await this.loadCourts()}catch(s){console.error("Failed to update PIN:",s),this.showToast("BÅ‚Ä…d aktualizacji PIN","error")}},async addCourt(){if(!this.newCourtId){this.showToast("WprowadÅº ID kortu","warning");return}if(this.newCourtPin&&(this.newCourtPin.length!==4||!/^\d{4}$/.test(this.newCourtPin))){this.showToast("PIN musi mieÄ‡ 4 cyfry","warning");return}try{if(!(await fetch("/admin/api/courts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kort_id:this.newCourtId,pin:this.newCourtPin||null})})).ok)throw new Error("Failed to add court");this.showToast(`Kort ${this.newCourtId} dodany`,"success"),this.newCourtId="",this.newCourtPin="",await this.loadCourts()}catch(t){console.error("Failed to add court:",t),this.showToast("BÅ‚Ä…d dodawania kortu","error")}},startEdit(t){this.editingCourt=t,this.editCourtId=t},cancelEdit(){this.editingCourt=null,this.editCourtId=""},async saveCourt(t){if(!this.editCourtId){this.showToast("ID kortu nie moÅ¼e byÄ‡ puste","warning");return}if(this.editCourtId===t){this.cancelEdit();return}try{const e=await fetch(`/admin/api/courts/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({kort_id:this.editCourtId})});if(!e.ok){const s=await e.json();throw new Error(s.error||"Failed to rename court")}this.showToast(`Kort ${t} zmieniono na ${this.editCourtId}`,"success"),this.cancelEdit(),await this.loadCourts()}catch(e){console.error("Failed to rename court:",e),this.showToast(e.message||"BÅ‚Ä…d zmiany nazwy kortu","error")}},async deleteCourt(t){if(confirm(`Czy na pewno chcesz usunÄ…Ä‡ Kort ${t}?`))try{if(!(await fetch(`/admin/api/courts/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete court");this.showToast(`Kort ${t} usuniÄ™ty`,"success"),await this.loadCourts()}catch(e){console.error("Failed to delete court:",e),this.showToast("BÅ‚Ä…d usuwania kortu","error")}},async loadTournaments(){this.loading.tournaments=!0;try{const t=await fetch("/admin/api/tournaments");if(!t.ok)throw new Error("Failed to load tournaments");if(this.tournaments=await t.json(),!this.selectedTournament){const e=this.tournaments.find(s=>s.active);e&&(this.selectedTournament=e.id,await this.loadPlayers(e.id))}}catch(t){console.error("Failed to load tournaments:",t),this.showToast("BÅ‚Ä…d Å‚adowania turniejÃ³w","error")}finally{this.loading.tournaments=!1}},async createTournament(){if(!this.newTournament.name||!this.newTournament.start_date||!this.newTournament.end_date){this.showToast("WypeÅ‚nij wszystkie pola","warning");return}try{if(!(await fetch("/admin/api/tournaments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.newTournament)})).ok)throw new Error("Failed to create tournament");this.showToast("Turniej utworzony","success"),this.newTournament={name:"",start_date:"",end_date:""},await this.loadTournaments()}catch(t){console.error("Failed to create tournament:",t),this.showToast("BÅ‚Ä…d tworzenia turnieju","error")}},async deleteTournament(t){if(confirm("Czy na pewno usunÄ…Ä‡ ten turniej?"))try{if(!(await fetch(`/admin/api/tournaments/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete tournament");this.showToast("Turniej usuniÄ™ty","success"),await this.loadTournaments()}catch(e){console.error("Failed to delete tournament:",e),this.showToast("BÅ‚Ä…d usuwania turnieju","error")}},async activateTournament(t){try{if(!(await fetch(`/admin/api/tournaments/${t}/activate`,{method:"POST"})).ok)throw new Error("Failed to activate tournament");this.showToast("Turniej aktywowany","success"),await this.loadTournaments()}catch(e){console.error("Failed to activate tournament:",e),this.showToast("BÅ‚Ä…d aktywacji turnieju","error")}},async selectTournament(t){this.selectedTournament=t,this.activeTab="players",await this.loadPlayers(t)},async loadPlayers(t){if(t){this.loading.players=!0;try{const e=await fetch(`/admin/api/tournaments/${t}/players`);if(!e.ok)throw new Error("Failed to load players");this.players=await e.json()}catch(e){console.error("Failed to load players:",e),this.showToast("BÅ‚Ä…d Å‚adowania graczy","error")}finally{this.loading.players=!1}}},async addPlayer(){if(!this.selectedTournament||!this.newPlayer.name){this.showToast("WprowadÅº imiÄ™ i nazwisko gracza","warning");return}try{if(!(await fetch(`/admin/api/tournaments/${this.selectedTournament}/players`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.newPlayer)})).ok)throw new Error("Failed to add player");this.showToast("Gracz dodany","success"),this.newPlayer={name:"",category:"",country:""},await this.loadPlayers(this.selectedTournament)}catch(t){console.error("Failed to add player:",t),this.showToast("BÅ‚Ä…d dodawania gracza","error")}},async deletePlayer(t){if(confirm("Czy na pewno usunÄ…Ä‡ tego gracza?"))try{if(!(await fetch(`/admin/api/tournaments/${this.selectedTournament}/players/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete player");this.showToast("Gracz usuniÄ™ty","success"),await this.loadPlayers(this.selectedTournament)}catch(e){console.error("Failed to delete player:",e),this.showToast("BÅ‚Ä…d usuwania gracza","error")}},async importPlayers(){if(!this.selectedTournament||!this.importText.trim()){this.showToast("WprowadÅº dane graczy","warning");return}try{const e=this.importText.trim().split(`
`).filter(a=>a.trim()).map(a=>{const o=a.trim().split(/\s+/),r=o.slice(0,-2).join(" ")||o.join(" "),n=o[o.length-2]||"",i=o[o.length-1]||"";return{name:r,category:n,country:i}});if(!(await fetch(`/admin/api/tournaments/${this.selectedTournament}/players/bulk`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({players:e})})).ok)throw new Error("Failed to import players");this.showToast(`Zaimportowano ${e.length} graczy`,"success"),this.importText="",await this.loadPlayers(this.selectedTournament)}catch(t){console.error("Failed to import players:",t),this.showToast("BÅ‚Ä…d importu graczy","error")}},async loadOverlaySettings(){try{const t=await fetch("/api/overlay/settings");if(t.ok){this.overlaySettings=await t.json();const e=Object.keys(this.overlaySettings.overlays||{});e.length&&!this.overlaySettings.overlays[this.currentOverlayId]&&(this.currentOverlayId=e[0])}}catch(t){console.error("Failed to load overlay settings:",t)}},async saveOverlaySettings(){try{const t=await fetch("/api/overlay/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.overlaySettings)});if(!t.ok)throw new Error("Failed to save settings");this.overlaySettings=await t.json()}catch(t){console.error("Failed to save overlay settings:",t),this.showToast("BÅ‚Ä…d zapisu ustawieÅ„ overlay","error")}},initSettingsSSE(){this._settingsSSE||(fetch("/api/snapshot").then(t=>t.json()).then(t=>{const e=t.courts||t;Object.keys(e).forEach(s=>{this.courtData[s]=e[s]})}).catch(()=>{}),this._settingsSSE=new EventSource("/api/stream"),this._settingsSSE.addEventListener("court_update",t=>{try{const e=JSON.parse(t.data);if(e.court_id){const s=e.court_id;delete e.court_id,this.courtData[s]=e}}catch(e){console.error("SSE parse:",e)}}),this._settingsSSE.onerror=()=>{this._settingsSSE.close(),this._settingsSSE=null,setTimeout(()=>{this.activeTab==="settings"&&this.initSettingsSSE()},5e3)})},updateCanvasScale(){var e;const t=(e=this.$refs)==null?void 0:e.canvasOuter;if(!t||!t.clientWidth){setTimeout(()=>this.updateCanvasScale(),100);return}this.canvasScale=t.clientWidth/1920},currentOverlay(){return(this.overlaySettings.overlays||{})[this.currentOverlayId]||null},currentElements(){var t;return((t=this.currentOverlay())==null?void 0:t.elements)||[]},selectedEl(){const t=this.currentElements();return this.selectedElIdx>=0&&this.selectedElIdx<t.length?t[this.selectedElIdx]:null},addOverlay(){const t=Object.keys(this.overlaySettings.overlays||{});let e="custom_1",s=1;for(;t.includes(e);)s++,e="custom_"+s;this.overlaySettings.overlays||(this.overlaySettings.overlays={}),this.overlaySettings.overlays[e]={name:"Nowy overlay "+s,auto_hide:!1,elements:[{type:"court",court_id:"1",visible:!0,x:24,y:860,w:460,show_logo:!0,font_size:17,bg_opacity:.95,logo_size:60,label_text:"KORT 1",label_position:"above",label_gap:4,label_bg_opacity:.85,label_font_size:14}]},this.currentOverlayId=e,this.selectedElIdx=-1,this.saveOverlaySettings(),this.showToast("Overlay dodany","success")},async removeOverlay(){var t;if(this.currentOverlayId&&confirm('UsunÄ…Ä‡ overlay "'+(((t=this.currentOverlay())==null?void 0:t.name)||this.currentOverlayId)+'"?'))try{if(!(await fetch("/api/overlay/overlays/"+encodeURIComponent(this.currentOverlayId),{method:"DELETE"})).ok)throw new Error("Failed");delete this.overlaySettings.overlays[this.currentOverlayId];const s=Object.keys(this.overlaySettings.overlays||{});this.currentOverlayId=s[0]||"",this.selectedElIdx=-1,this.showToast("Overlay usuniÄ™ty","success")}catch{this.showToast("BÅ‚Ä…d usuwania overlay","error")}},updateOverlayProp(t,e){const s=this.currentOverlay();s&&(s[t]=e,this.saveOverlaySettings())},addElement(t){const e=this.currentOverlay();e&&(t==="court"?e.elements.push({type:"court",court_id:this.addElCourtId||"1",visible:!0,x:100,y:100,w:460,show_logo:!0,font_size:17,bg_opacity:.95,logo_size:60,label_text:"KORT "+(this.addElCourtId||"1"),label_position:"above",label_gap:4,label_bg_opacity:.85,label_font_size:14}):e.elements.push({type:"stats",court_id:this.addElCourtId||"1",visible:!0,x:100,y:400,w:360}),this.selectedElIdx=e.elements.length-1,this.saveOverlaySettings())},removeElement(){const t=this.currentOverlay();!t||this.selectedElIdx<0||(t.elements.splice(this.selectedElIdx,1),this.selectedElIdx=-1,this.saveOverlaySettings())},setElProp(t,e){const s=this.selectedEl();s&&(s[t]=e,this.saveOverlaySettings())},startDrag(t,e){var c,h;const s=this.$refs.canvasOuter;if(!s)return;const a=s.getBoundingClientRect(),o=this.canvasScale,r=this.currentElements()[e];if(!r)return;const n=r.x*o,i=r.y*o;this.dragging={idx:e,offsetX:t.clientX-a.left-n,offsetY:t.clientY-a.top-i},this.selectedElIdx=e,(h=(c=t.target).setPointerCapture)==null||h.call(c,t.pointerId)},onDrag(t){if(!this.dragging)return;const e=this.$refs.canvasOuter;if(!e)return;const s=e.getBoundingClientRect(),a=this.canvasScale,o=this.currentElements()[this.dragging.idx];if(!o)return;let r=(t.clientX-s.left-this.dragging.offsetX)/a,n=(t.clientY-s.top-this.dragging.offsetY)/a;o.x=Math.max(0,Math.min(1920-(o.w||260),Math.round(r))),o.y=Math.max(0,Math.min(1e3,Math.round(n)))},async endDrag(t){this.dragging&&(this.dragging=null,await this.saveOverlaySettings())},renderLiveScoreboard(t){var T,b,_,S;const e=t.court_id,s=this.courtData[e]||{},a=s.A||{},o=s.B||{},r=((T=s.match_status)==null?void 0:T.active)||!1,n=s.current_set||1,i=t.logo_size||60,c=t.bg_opacity!=null?t.bg_opacity:.95,h=[];for(let l=1;l<=3;l++){const d=a["set"+l],u=o["set"+l];(l<=n||d>0||u>0)&&h.push({idx:l,a:d||0,b:u||0})}h.length||h.push({idx:1,a:0,b:0});const p=((b=s.tie)==null?void 0:b.visible)||!1,C=p?((_=s.tie)==null?void 0:_.A)||0:a.points||"0",E=p?((S=s.tie)==null?void 0:S.B)||0:o.points||"0",O=p?" is-tiebreak":"",f=this.overlaySettings.tournament_logo,x=t.show_logo,I=r?"":"match-inactive",k="grid-template-columns:minmax(0,2.3fr) minmax(0,1.2fr) repeat("+h.length+",minmax(0,0.95fr));";function v(l,d,u){const z=s.serve===d;let w="";l.flag_url?w='<span class="sb-flag has-image" style="background-image:url('+l.flag_url+')"></span>':w='<span class="sb-flag">'+(l.flag_code||"").toUpperCase()+"</span>";const j=z?'<span class="sb-serve">ðŸŽ¾</span>':"",F='<div class="sb-player-cell">'+w+'<span class="sb-name">'+(l.surname||l.full_name||"â€”")+"</span>"+j+"</div>",$=d==="A"?C:E,D=r?'<div class="sb-metric pts'+O+'">'+$+"</div>":'<div class="sb-metric pts">â€”</div>',B=h.map(y=>{const L=d==="A"?y.a:y.b;return'<div class="sb-metric set'+(y.idx===n?" is-active":"")+'">'+L+"</div>"}).join("");return'<div class="sb-row '+u+'" style="'+k+'">'+F+D+B+"</div>"}let g="";x&&(f?g='<div class="sb-logo" style="width:'+i+"px;height:"+i+'px;"><img src="'+f+'" alt=""></div>':g='<div class="sb-logo" style="width:'+i+"px;height:"+i+'px;"><div class="sb-logo-ph">ðŸŽ¾</div></div>');const P=c<1?"opacity:"+c+";":"";return'<div class="sb-wrap '+I+'">'+g+'<div class="sb-table" style="'+P+'">'+v(a,"A","side-a")+v(o,"B","side-b")+"</div></div>"},renderCourtElement(t){const e=this.renderLiveScoreboard(t);if(!t.label_text||t.label_position==="none")return e;const s=t.label_position||"above",a="rgba(0,0,0,"+(t.label_bg_opacity!=null?t.label_bg_opacity:.7)+")",o=t.label_font_size||14,r=t.label_gap!=null?t.label_gap:4,n=s==="above"?"margin-bottom":"margin-top",i=s==="above"?"border-radius:6px 6px 0 0;":"border-radius:0 0 6px 6px;",c='<div class="sb-label-bar" style="background:'+a+";font-size:"+o+"px;"+n+":"+r+"px;"+i+'">'+t.label_text+"</div>";return s==="above"?c+e:e+c},onLogoFileSelect(t){var a;const e=(a=t.target.files)==null?void 0:a[0];if(!e)return;const s=new FileReader;s.onload=o=>{this.cropImgSrc=o.target.result,this.cropZoom=100,this._cropOffset={x:0,y:0},this.$refs.cropModal.showModal(),this.$nextTick(()=>this.updateCropTransform())},s.readAsDataURL(e)},updateCropTransform(){const t=this.$refs.cropImg;if(!t)return;const e=this.cropZoom/100;t.style.width=200*e+"px",t.style.height="auto",t.style.left=this._cropOffset.x+"px",t.style.top=this._cropOffset.y+"px"},startCropDrag(t){var e,s;this._cropDragging=!0,this._cropStart={x:t.clientX-this._cropOffset.x,y:t.clientY-this._cropOffset.y},(s=(e=t.target).setPointerCapture)==null||s.call(e,t.pointerId)},onCropDrag(t){this._cropDragging&&(this._cropOffset={x:t.clientX-this._cropStart.x,y:t.clientY-this._cropStart.y},this.updateCropTransform())},endCropDrag(){this._cropDragging=!1},async applyCrop(){const t=document.createElement("canvas");t.width=200,t.height=200;const e=t.getContext("2d"),s=this.$refs.cropImg;if(!s)return;const o=200*(this.cropZoom/100),r=s.naturalHeight*(o/s.naturalWidth);e.drawImage(s,this._cropOffset.x,this._cropOffset.y,o,r);const n=t.toDataURL("image/png");this.$refs.cropModal.close();try{const i=await fetch("/api/overlay/logo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({logo:n})});if(!i.ok)throw new Error("Upload failed");const c=await i.json();this.overlaySettings.tournament_logo=c.tournament_logo||n,this.showToast("Logo zapisane","success")}catch{this.showToast("BÅ‚Ä…d uploadu logo","error")}},async removeLogo(){try{await fetch("/api/overlay/logo",{method:"DELETE"}),this.overlaySettings.tournament_logo=null,this.showToast("Logo usuniÄ™te","success")}catch{this.showToast("BÅ‚Ä…d usuwania logo","error")}},async copyUrl(t){try{await navigator.clipboard.writeText(t),this.showToast("URL skopiowany do schowka","success")}catch{const s=document.createElement("textarea");s.value=t,document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s),this.showToast("URL skopiowany","success")}}}));m.start();
