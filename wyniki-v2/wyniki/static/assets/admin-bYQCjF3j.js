import{m as S}from"./main-CbaNQPvU.js";window.Alpine=S;function L(t){return!t||t.length<2?"":"https://flagcdn.com/w40/"+t.toLowerCase().slice(0,2)+".png"}S.data("adminApp",()=>({activeTab:"courts",courts:[],newCourtId:"",newCourtPin:"",editingCourt:null,editCourtId:"",tournaments:[],selectedTournament:null,newTournament:{name:"",start_date:"",end_date:""},players:[],newPlayer:{first_name:"",last_name:"",category:"",country:""},importText:"",overlaySettings:{tournament_logo:null,tournament_name:"",overlays:{}},currentOverlayId:"1",selectedElIdx:-1,selectedElIdxSet:[],canvasScale:1,hoveredElIdx:-1,dragging:null,resizing:null,keepAspectRatio:!1,courtData:{},_settingsSSE:null,demoPreview:!1,demoOverlayActive:!1,addElCourtId:"1",snapEnabled:!0,snapThreshold:10,cropImgSrc:"",cropZoom:100,_cropDragging:!1,_cropStart:{x:0,y:0},_cropOffset:{x:0,y:0},loading:{courts:!1,tournaments:!1,players:!1},toast:{show:!1,message:"",type:"info"},get filteredPlayers(){return this.players},init(){this.loadCourts(),this.loadTournaments(),this.loadOverlaySettings(),this._loadDemoStatus(),window.addEventListener("resize",()=>this.updateCanvasScale()),this.$nextTick(()=>this.updateCanvasScale()),window.addEventListener("keydown",t=>this._handleKeyNudge(t))},showToast(t,e="info"){this.toast={show:!0,message:t,type:e},setTimeout(()=>{this.toast.show=!1},3e3)},async loadCourts(){this.loading.courts=!0;try{const t=await fetch("/admin/api/courts");if(!t.ok)throw new Error("Failed to load courts");this.courts=await t.json(),this.courts.length&&!this.courts.find(e=>String(e.kort_id)===this.addElCourtId)&&(this.addElCourtId=String(this.courts[0].kort_id))}catch(t){console.error("Failed to load courts:",t),this.showToast("B≈ÇƒÖd ≈Çadowania kort√≥w","error")}finally{this.loading.courts=!1}},async refreshCourts(){await this.loadCourts(),this.showToast("Korty od≈õwie≈ºone","success")},async updateCourtPin(t,e){try{if(e&&(e.length!==4||!/^\d{4}$/.test(e))){this.showToast("PIN musi mieƒá 4 cyfry","warning"),await this.loadCourts();return}if(!(await fetch(`/admin/api/courts/${t}/pin`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({pin:e||null})})).ok)throw new Error("Failed to update PIN");this.showToast(`PIN dla kortu ${t} zaktualizowany`,"success"),await this.loadCourts()}catch(s){console.error("Failed to update PIN:",s),this.showToast("B≈ÇƒÖd aktualizacji PIN","error")}},async addCourt(){if(!this.newCourtId){this.showToast("Wprowad≈∫ ID kortu","warning");return}if(this.newCourtPin&&(this.newCourtPin.length!==4||!/^\d{4}$/.test(this.newCourtPin))){this.showToast("PIN musi mieƒá 4 cyfry","warning");return}try{if(!(await fetch("/admin/api/courts",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({kort_id:this.newCourtId,pin:this.newCourtPin||null})})).ok)throw new Error("Failed to add court");const e=this.newCourtId;this.showToast(`Kort ${e} dodany`,"success"),this.newCourtId="",this.newCourtPin="",await this.loadCourts(),this._addCourtToOverlays(e)}catch(t){console.error("Failed to add court:",t),this.showToast("B≈ÇƒÖd dodawania kortu","error")}},startEdit(t){this.editingCourt=t,this.editCourtId=t},cancelEdit(){this.editingCourt=null,this.editCourtId=""},async saveCourt(t){if(!this.editCourtId){this.showToast("ID kortu nie mo≈ºe byƒá puste","warning");return}if(this.editCourtId===t){this.cancelEdit();return}try{const e=await fetch(`/admin/api/courts/${t}`,{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify({kort_id:this.editCourtId})});if(!e.ok){const s=await e.json();throw new Error(s.error||"Failed to rename court")}this.showToast(`Kort ${t} zmieniono na ${this.editCourtId}`,"success"),this.cancelEdit(),await this.loadCourts()}catch(e){console.error("Failed to rename court:",e),this.showToast(e.message||"B≈ÇƒÖd zmiany nazwy kortu","error")}},async deleteCourt(t){if(confirm(`Czy na pewno chcesz usunƒÖƒá Kort ${t}?`))try{if(!(await fetch(`/admin/api/courts/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete court");this.showToast(`Kort ${t} usuniƒôty`,"success"),await this.loadCourts(),this._removeCourtFromOverlays(t)}catch(e){console.error("Failed to delete court:",e),this.showToast("B≈ÇƒÖd usuwania kortu","error")}},async loadTournaments(){this.loading.tournaments=!0;try{const t=await fetch("/admin/api/tournaments");if(!t.ok)throw new Error("Failed to load tournaments");if(this.tournaments=await t.json(),!this.selectedTournament){const e=this.tournaments.find(s=>s.active);e&&(this.selectedTournament=e.id,await this.loadPlayers(e.id))}}catch(t){console.error("Failed to load tournaments:",t),this.showToast("B≈ÇƒÖd ≈Çadowania turniej√≥w","error")}finally{this.loading.tournaments=!1}},async createTournament(){if(!this.newTournament.name||!this.newTournament.start_date||!this.newTournament.end_date){this.showToast("Wype≈Çnij wszystkie pola","warning");return}try{if(!(await fetch("/admin/api/tournaments",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.newTournament)})).ok)throw new Error("Failed to create tournament");this.showToast("Turniej utworzony","success"),this.newTournament={name:"",start_date:"",end_date:""},await this.loadTournaments()}catch(t){console.error("Failed to create tournament:",t),this.showToast("B≈ÇƒÖd tworzenia turnieju","error")}},async deleteTournament(t){if(confirm("Czy na pewno usunƒÖƒá ten turniej?"))try{if(!(await fetch(`/admin/api/tournaments/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete tournament");this.showToast("Turniej usuniƒôty","success"),await this.loadTournaments()}catch(e){console.error("Failed to delete tournament:",e),this.showToast("B≈ÇƒÖd usuwania turnieju","error")}},async activateTournament(t){try{if(!(await fetch(`/admin/api/tournaments/${t}/activate`,{method:"POST"})).ok)throw new Error("Failed to activate tournament");this.showToast("Turniej aktywowany","success"),await this.loadTournaments()}catch(e){console.error("Failed to activate tournament:",e),this.showToast("B≈ÇƒÖd aktywacji turnieju","error")}},async selectTournament(t){this.selectedTournament=t,this.activeTab="players",await this.loadPlayers(t)},async loadPlayers(t){if(t){this.loading.players=!0;try{const e=await fetch(`/admin/api/tournaments/${t}/players`);if(!e.ok)throw new Error("Failed to load players");this.players=await e.json()}catch(e){console.error("Failed to load players:",e),this.showToast("B≈ÇƒÖd ≈Çadowania graczy","error")}finally{this.loading.players=!1}}},async addPlayer(){if(!this.selectedTournament||!this.newPlayer.last_name){this.showToast("Wprowad≈∫ nazwisko gracza","warning");return}try{if(!(await fetch(`/admin/api/tournaments/${this.selectedTournament}/players`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.newPlayer)})).ok)throw new Error("Failed to add player");this.showToast("Gracz dodany","success"),this.newPlayer={first_name:"",last_name:"",category:"",country:""},await this.loadPlayers(this.selectedTournament)}catch(t){console.error("Failed to add player:",t),this.showToast("B≈ÇƒÖd dodawania gracza","error")}},async deletePlayer(t){if(confirm("Czy na pewno usunƒÖƒá tego gracza?"))try{if(!(await fetch(`/admin/api/tournaments/${this.selectedTournament}/players/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete player");this.showToast("Gracz usuniƒôty","success"),await this.loadPlayers(this.selectedTournament)}catch(e){console.error("Failed to delete player:",e),this.showToast("B≈ÇƒÖd usuwania gracza","error")}},async importPlayers(){if(!this.selectedTournament||!this.importText.trim()){this.showToast("Wprowad≈∫ dane graczy","warning");return}try{const e=this.importText.trim().split(`
`).filter(r=>r.trim()).map(r=>{const a=r.trim().split(/\s+/),o=a.slice(0,-2).join(" ")||a.join(" "),n=a[a.length-2]||"",l=a[a.length-1]||"";return{name:o,category:n,country:l}});if(!(await fetch(`/admin/api/tournaments/${this.selectedTournament}/players/bulk`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({players:e})})).ok)throw new Error("Failed to import players");this.showToast(`Zaimportowano ${e.length} graczy`,"success"),this.importText="",await this.loadPlayers(this.selectedTournament)}catch(t){console.error("Failed to import players:",t),this.showToast("B≈ÇƒÖd importu graczy","error")}},async loadOverlaySettings(){try{const t=await fetch("/api/overlay/settings");if(t.ok){this.overlaySettings=await t.json(),Object.values(this.overlaySettings.overlays||{}).forEach(s=>this._ensureGridDefaults(s));const e=Object.keys(this.overlaySettings.overlays||{});e.length&&!this.overlaySettings.overlays[this.currentOverlayId]&&(this.currentOverlayId=e[0])}}catch(t){console.error("Failed to load overlay settings:",t)}},async saveOverlaySettings(){try{const t=await fetch("/api/overlay/settings",{method:"PUT",headers:{"Content-Type":"application/json"},body:JSON.stringify(this.overlaySettings)});if(!t.ok)throw new Error("Failed to save settings");this.overlaySettings=await t.json()}catch(t){console.error("Failed to save overlay settings:",t),this.showToast("B≈ÇƒÖd zapisu ustawie≈Ñ overlay","error")}},async _loadDemoStatus(){try{const t=await fetch("/admin/api/demo/status");if(t.ok){const e=await t.json();this.demoOverlayActive=e.demo_overlay_active||!1,e.demo_loaded&&e.demo_courts&&(this.demoPreview=!0,Object.keys(e.demo_courts).forEach(s=>{this.courtData[s]=e.demo_courts[s]}),this._fitPreviewNames())}}catch{}},async loadDemoData(){try{const t=await fetch("/admin/api/demo",{method:"POST"}),e=await t.json();if(!t.ok){this.showToast(e.error||"B≈ÇƒÖd ≈Çadowania demo","error");return}e.demo_courts&&Object.keys(e.demo_courts).forEach(s=>{this.courtData[s]=e.demo_courts[s]}),this.demoPreview=!0,this.demoOverlayActive=e.demo_overlay_active||!1,this._fitPreviewNames(),this.showToast(e.message||"Demo za≈Çadowane (tylko podglƒÖd)","success")}catch(t){console.error("Demo load error:",t),this.showToast("B≈ÇƒÖd ≈Çadowania demo","error")}},async toggleDemoOverlay(){const t=!this.demoOverlayActive;try{const e=await fetch("/admin/api/demo/overlay",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({active:t})}),s=await e.json();if(!e.ok){this.showToast(s.error||"B≈ÇƒÖd prze≈ÇƒÖczania demo","error");return}this.demoOverlayActive=s.active,this.showToast(s.message,s.active?"warning":"success")}catch(e){console.error("Demo overlay toggle error:",e),this.showToast("B≈ÇƒÖd prze≈ÇƒÖczania demo","error")}},async clearDemo(){try{const t=await fetch("/admin/api/demo",{method:"DELETE"}),e=await t.json();if(!t.ok){this.showToast(e.error||"B≈ÇƒÖd czyszczenia demo","error");return}this.demoPreview=!1,this.demoOverlayActive=!1;try{const s=await fetch("/api/snapshot").then(a=>a.json()),r=s.courts||s;Object.keys(r).forEach(a=>{this.courtData[a]=r[a]}),this._fitPreviewNames()}catch{}this.showToast("Demo wyczyszczone","success")}catch(t){console.error("Demo clear error:",t),this.showToast("B≈ÇƒÖd czyszczenia demo","error")}},initSettingsSSE(){this._settingsSSE||(this.demoPreview||fetch("/api/snapshot").then(t=>t.json()).then(t=>{if(this.demoPreview)return;const e=t.courts||t;Object.keys(e).forEach(s=>{this.courtData[s]=e[s]}),this._fitPreviewNames()}).catch(()=>{}),this._settingsSSE=new EventSource("/api/stream"),this._settingsSSE.addEventListener("court_update",t=>{try{const e=JSON.parse(t.data);if(e.court_id){if(this.demoPreview)return;const s=e.court_id;delete e.court_id,this.courtData[s]=e,this._fitPreviewNames()}}catch(e){console.error("SSE parse:",e)}}),this._settingsSSE.onerror=()=>{this._settingsSSE.close(),this._settingsSSE=null,setTimeout(()=>{this.activeTab==="settings"&&this.initSettingsSSE()},5e3)})},updateCanvasScale(){var e;const t=(e=this.$refs)==null?void 0:e.canvasOuter;if(!t||!t.clientWidth){setTimeout(()=>this.updateCanvasScale(),100);return}this.canvasScale=t.clientWidth/1920},currentOverlay(){return(this.overlaySettings.overlays||{})[this.currentOverlayId]||null},currentElements(){var t;return((t=this.currentOverlay())==null?void 0:t.elements)||[]},selectedEl(){const t=this.currentElements();return this.selectedElIdx>=0&&this.selectedElIdx<t.length?t[this.selectedElIdx]:null},_handleKeyNudge(t){var l;if(this.activeTab!=="settings"||this.selectedElIdx<0)return;const e=(l=document.activeElement)==null?void 0:l.tagName;if(e==="INPUT"||e==="SELECT"||e==="TEXTAREA")return;const r={ArrowLeft:[-1,0],ArrowRight:[1,0],ArrowUp:[0,-1],ArrowDown:[0,1]}[t.key];if(!r)return;t.preventDefault();const a=t.shiftKey?10:1,o=this.selectedElIdxSet.length>0?this.selectedElIdxSet:[this.selectedElIdx],n=this.currentElements();o.forEach(i=>{var u,c;const h=n[i];h&&(h.zone==="top"&&((c=(u=this.currentOverlay())==null?void 0:u.top_bar)!=null&&c.enabled)||(h.x=Math.round(h.x+r[0]*a),h.y=Math.round(h.y+r[1]*a)))}),this.saveOverlaySettings()},toggleMultiSelect(t,e){if(e.shiftKey){const s=this.selectedElIdxSet.indexOf(t);s>=0?this.selectedElIdxSet.splice(s,1):this.selectedElIdxSet.push(t),this.selectedElIdx=t}else this.selectedElIdx=t,this.selectedElIdxSet=[t]},isMultiSelected(t){return this.selectedElIdxSet.includes(t)},_getAlignTargets(){const t=this.currentElements();return this.selectedElIdxSet.length>=2?this.selectedElIdxSet.map(e=>t[e]).filter(Boolean):t.filter(e=>e.visible!==!1&&e.zone==="free")},_ensureGridDefaults(t){t.top_bar||(t.top_bar={enabled:!1,columns:3,margin_x:0,margin_top:0,gap:10}),(t.elements||[]).forEach(e=>{e.zone||(e.zone="free")})},applyTopBarGrid(){var u;const t=this.currentOverlay();if(!((u=t==null?void 0:t.top_bar)!=null&&u.enabled))return;const e=(t.elements||[]).filter(c=>c.zone==="top");if(e.length===0)return;const s=t.top_bar.columns||3,r=t.top_bar.margin_x||0,a=t.top_bar.margin_top||0,o=t.top_bar.gap||10,n=1920-2*r,l=e.length>s?s:e.length,i=Math.round((n-(l-1)*o)/l),h=e[0].h||null;e.forEach((c,f)=>{if(f>=s)return;const y=r+f*(i+o);c.x=Math.round(y),c.y=a,c.w=i,h&&(c.h=h)})},_syncTopBarSizes(t){var r;const e=this.currentOverlay();if(!((r=e==null?void 0:e.top_bar)!=null&&r.enabled)||t.zone!=="top")return;(e.elements||[]).filter(a=>a.zone==="top").forEach(a=>{a!==t&&(a.w=t.w,t.h&&(a.h=t.h))}),this.applyTopBarGrid()},setTopBarProp(t,e){const s=this.currentOverlay();s&&(s.top_bar||(s.top_bar={enabled:!1,columns:3,margin_x:0,margin_top:0,gap:10}),s.top_bar[t]=e,s.top_bar.enabled&&this.applyTopBarGrid(),this.saveOverlaySettings())},setElZone(t){const e=this.selectedEl();e&&(e.zone=t,t==="top"&&this.applyTopBarGrid(),this.saveOverlaySettings())},snapToEdge(t){const e=this.selectedEl();if(!e)return;const s=e.w||460,r=e.h||80;switch(t){case"bottom-left":e.x=0,e.y=1080-r;break;case"bottom-center":e.x=Math.round((1920-s)/2),e.y=1080-r;break;case"bottom-right":e.x=1920-s,e.y=1080-r;break;case"top-left":e.x=0,e.y=0;break;case"top-center":e.x=Math.round((1920-s)/2),e.y=0;break;case"top-right":e.x=1920-s,e.y=0;break}this.saveOverlaySettings()},alignElements(t){const e=this._getAlignTargets();if(!(e.length<2)){switch(t){case"left":{const s=Math.min(...e.map(r=>r.x));e.forEach(r=>r.x=s);break}case"right":{const s=Math.max(...e.map(r=>r.x+(r.w||460)));e.forEach(r=>r.x=s-(r.w||460));break}case"center-h":{const s=Math.round(e.reduce((r,a)=>r+a.x+(a.w||460)/2,0)/e.length);e.forEach(r=>r.x=Math.round(s-(r.w||460)/2));break}case"top":{const s=Math.min(...e.map(r=>r.y));e.forEach(r=>r.y=s);break}case"bottom":{const s=Math.max(...e.map(r=>r.y+(r.h||80)));e.forEach(r=>r.y=s-(r.h||80));break}case"center-v":{const s=Math.round(e.reduce((r,a)=>r+a.y+(a.h||80)/2,0)/e.length);e.forEach(r=>r.y=Math.round(s-(r.h||80)/2));break}}this.saveOverlaySettings()}},distributeElements(t){const e=this._getAlignTargets();if(!(e.length<3)){if(t==="horizontal"){e.sort((o,n)=>o.x-n.x);const s=e[0].x,a=(e[e.length-1].x-s)/(e.length-1);e.forEach((o,n)=>{o.x=Math.round(s+n*a)})}else{e.sort((o,n)=>o.y-n.y);const s=e[0].y,a=(e[e.length-1].y-s)/(e.length-1);e.forEach((o,n)=>{o.y=Math.round(s+n*a)})}this.saveOverlaySettings()}},_snapPosition(t,e,s,r){var y;if(!this.snapEnabled)return{x:t,y:e};const a=this.snapThreshold,o=[0,960,1920,1920/3,1920*2/3,1920/4,1920*3/4],n=[0,540,1080],l=this.currentElements(),i=((y=this.dragging)==null?void 0:y.idx)??-1;l.forEach((d,p)=>{if(p===i||d.visible===!1)return;const g=d.w||460,v=d.h||80;o.push(d.x,d.x+g,d.x+g/2),n.push(d.y,d.y+v,d.y+v/2)});let h=t,u=e,c=a+1,f=a+1;for(const d of o){const p=Math.abs(t-d),g=Math.abs(t+s-d),v=Math.abs(t+s/2-d);p<c&&(c=p,h=d),g<c&&(c=g,h=d-s),v<c&&(c=v,h=d-s/2)}c>a&&(h=t);for(const d of n){const p=Math.abs(e-d),g=Math.abs(e+r-d),v=Math.abs(e+r/2-d);p<f&&(f=p,u=d),g<f&&(f=g,u=d-r),v<f&&(f=v,u=d-r/2)}return f>a&&(u=e),{x:Math.round(h),y:Math.round(u)}},copyLayoutTo(t){const e=this.currentOverlay(),s=(this.overlaySettings.overlays||{})[t];!e||!s||(s.elements=JSON.parse(JSON.stringify(e.elements)),s.top_bar=JSON.parse(JSON.stringify(e.top_bar||{enabled:!1,columns:3,margin_x:0,margin_top:0,gap:10})),this.saveOverlaySettings(),this.showToast('Layout skopiowany do "'+(s.name||t)+'"',"success"))},applyTemplate(t){const e=this.currentOverlay();if(!e)return;const s=this.courts.map(c=>String(c.kort_id)).sort((c,f)=>+c-+f);if(s.length===0){this.showToast("Brak kort√≥w ‚Äî dodaj korty najpierw","warning");return}const r=(c,f,y,d,p={})=>({type:"court",court_id:String(c),visible:!0,x:f,y,w:d,zone:p.zone||"free",show_logo:p.logo||!1,font_size:p.fs||17,bg_opacity:.95,logo_size:60,label_text:p.label||(p.noLabel?"":"KORT "+c),label_position:p.labelPos||"above",label_gap:4,label_bg_opacity:.85,label_font_size:p.lfs||14}),a=c=>{const f=s.filter(d=>d!==String(c)),y=Math.min(f.length,4);return{top_bar:{enabled:!0,columns:y,margin_x:20,margin_top:10,gap:12},elements:[r(c,30,890,600,{zone:"free",logo:!1,labelPos:"above"}),...f.slice(0,y).map((d,p)=>r(d,20+p*634,10,620,{zone:"top",logo:!1,labelPos:"below",fs:14,lfs:12}))]}},o={};s.forEach(c=>{o["kort"+c+"-focus"]=a(c)});const n=c=>{const f=s.slice(0,c);return{top_bar:{enabled:!0,columns:f.length,margin_x:20,margin_top:10,gap:12},elements:f.map((y,d)=>r(y,20+d*634,10,620,{zone:"top",logo:!1,labelPos:"below",lfs:12}))}};o["3kort-top"]=n(3),o["4kort-top"]=n(4),o["all-top"]=n(s.length);const l=s[0],i=s.slice(1);o["main+stats"]={top_bar:{enabled:!1,columns:3,margin_x:0,margin_top:0,gap:10},elements:[r(l,30,890,600,{logo:!1,labelPos:"above"}),{type:"stats",court_id:l,visible:!0,x:1540,y:860,w:360,zone:"free"}]};const h=Math.min(i.length,4);o.broadcast={top_bar:{enabled:!0,columns:h||3,margin_x:20,margin_top:10,gap:12},elements:[...i.slice(0,h).map((c,f)=>r(c,20+f*634,10,620,{zone:"top",logo:!1,labelPos:"below",lfs:12})),r(l,30,890,600,{logo:!1,labelPos:"above"}),{type:"stats",court_id:l,visible:!0,x:1540,y:860,w:360,zone:"free"}]};const u=o[t];if(!u){this.showToast("Nieznany szablon: "+t,"warning");return}confirm("Zastosowaƒá szablon? Obecne elementy zostanƒÖ zastƒÖpione.")&&(e.elements=JSON.parse(JSON.stringify(u.elements)),e.top_bar=JSON.parse(JSON.stringify(u.top_bar)),e.top_bar.enabled&&this.applyTopBarGrid(),this.selectedElIdx=-1,this.selectedElIdxSet=[],this.saveOverlaySettings(),this.showToast("Szablon zastosowany","success"))},duplicateElement(){const t=this.currentOverlay(),e=this.selectedEl();if(!t||!e)return;const s=JSON.parse(JSON.stringify(e));s.x+=30,s.y+=30,s.zone="free",t.elements.push(s),this.selectedElIdx=t.elements.length-1,this.selectedElIdxSet=[this.selectedElIdx],this.saveOverlaySettings(),this.showToast("Element zduplikowany","success")},matchSize(){if(this.selectedElIdxSet.length<2)return;const t=this.currentElements(),e=t[this.selectedElIdxSet[0]];if(e){for(let s=1;s<this.selectedElIdxSet.length;s++){const r=t[this.selectedElIdxSet[s]];r&&(r.w=e.w,e.h&&(r.h=e.h))}this.saveOverlaySettings(),this.showToast("Rozmiary wyr√≥wnane","success")}},centerOnScreen(t){const e=this.selectedEl();e&&((t==="h"||t==="both")&&(e.x=Math.round((1920-(e.w||460))/2)),(t==="v"||t==="both")&&(e.y=Math.round((1080-(e.h||80))/2)),this.saveOverlaySettings())},getRulerInfo(){if(this.hoveredElIdx<0||this.selectedElIdx<0||this.hoveredElIdx===this.selectedElIdx)return null;const t=this.currentElements(),e=t[this.selectedElIdx],s=t[this.hoveredElIdx];if(!e||!s)return null;const r=e.x,a=e.y,o=e.w||460,n=e.h||80,l=s.x,i=s.y,h=s.w||460,u=s.h||80,c=l-(r+o),f=i-(a+n),y=r-(l+h),d=a-(i+u);return{ax:r,ay:a,aw:o,ah:n,bx:l,by:i,bw:h,bh:u,gapRight:c,gapBottom:f,gapLeft:y,gapTop:d}},renderRulerSVG(){const t=this.getRulerInfo();if(!t)return"";const e=this.canvasScale;let s=`<svg xmlns="http://www.w3.org/2000/svg" style="width:${1920*e}px;height:${1080*e}px;position:absolute;inset:0;pointer-events:none;z-index:300;">`;if(t.gapRight>5||t.gapLeft>5){const r=t.gapRight>5,a=(r?t.ax+t.aw:t.bx+t.bw)*e,o=(r?t.bx:t.ax)*e,n=Math.max(t.ay+t.ah/2,t.by+t.bh/2)*e,l=Math.abs(r?t.gapRight:t.gapLeft),i=(a+o)/2;s+=`<line x1="${a}" y1="${n}" x2="${o}" y2="${n}" class="ruler-line"/>`,s+=`<rect x="${i-16*e}" y="${n-8*e}" width="${32*e}" height="${16*e}" class="ruler-bg"/>`,s+=`<text x="${i}" y="${n+4*e}" class="ruler-text">${l}px</text>`}if(t.gapBottom>5||t.gapTop>5){const r=t.gapBottom>5,a=(r?t.ay+t.ah:t.by+t.bh)*e,o=(r?t.by:t.ay)*e,n=Math.max(t.ax+t.aw/2,t.bx+t.bw/2)*e,l=Math.abs(r?t.gapBottom:t.gapTop),i=(a+o)/2;s+=`<line x1="${n}" y1="${a}" x2="${n}" y2="${o}" class="ruler-line"/>`,s+=`<rect x="${n-16*e}" y="${i-8*e}" width="${32*e}" height="${16*e}" class="ruler-bg"/>`,s+=`<text x="${n}" y="${i+4*e}" class="ruler-text">${l}px</text>`}return s+="</svg>",s},_addCourtToOverlays(t){const e=this.overlaySettings.overlays||{},s=String(t);let r=!1;Object.values(e).forEach(a=>{if((a.elements||[]).some(i=>i.court_id===s))return;const n=(a.elements||[]).find(i=>i.type==="court"),l=n?JSON.parse(JSON.stringify(n)):{type:"court",visible:!0,x:100,y:100,w:460,show_logo:!0,font_size:17,bg_opacity:.95,logo_size:60,zone:"free",label_position:"above",label_gap:4,label_bg_opacity:.85,label_font_size:14};l.court_id=s,l.label_text="KORT "+s,n&&(l.x=Math.min(1920-(l.w||460),(n.x||0)+40),l.y=Math.min(1e3,(n.y||0)+40)),l.zone="free",a.elements||(a.elements=[]),a.elements.push(l),r=!0}),r&&this.saveOverlaySettings()},_removeCourtFromOverlays(t){const e=this.overlaySettings.overlays||{},s=String(t);let r=!1;Object.values(e).forEach(a=>{const o=(a.elements||[]).length;a.elements=(a.elements||[]).filter(n=>n.court_id!==s),a.elements.length!==o&&(r=!0)}),r&&(this.selectedElIdx=-1,this.selectedElIdxSet=[],this.saveOverlaySettings())},addOverlay(){const t=Object.keys(this.overlaySettings.overlays||{});let e="custom_1",s=1;for(;t.includes(e);)s++,e="custom_"+s;this.overlaySettings.overlays||(this.overlaySettings.overlays={}),this.overlaySettings.overlays[e]={name:"Nowy overlay "+s,auto_hide:!1,top_bar:{enabled:!1,columns:3,margin_x:0,margin_top:0,gap:10},elements:[{type:"court",court_id:"1",visible:!0,x:24,y:860,w:460,zone:"free",show_logo:!0,font_size:17,bg_opacity:.95,logo_size:60,label_text:"KORT 1",label_position:"above",label_gap:4,label_bg_opacity:.85,label_font_size:14}]},this.currentOverlayId=e,this.selectedElIdx=-1,this.saveOverlaySettings(),this.showToast("Overlay dodany","success")},async removeOverlay(){var t;if(this.currentOverlayId&&confirm('UsunƒÖƒá overlay "'+(((t=this.currentOverlay())==null?void 0:t.name)||this.currentOverlayId)+'"?'))try{if(!(await fetch("/api/overlay/overlays/"+encodeURIComponent(this.currentOverlayId),{method:"DELETE"})).ok)throw new Error("Failed");delete this.overlaySettings.overlays[this.currentOverlayId];const s=Object.keys(this.overlaySettings.overlays||{});this.currentOverlayId=s[0]||"",this.selectedElIdx=-1,this.showToast("Overlay usuniƒôty","success")}catch{this.showToast("B≈ÇƒÖd usuwania overlay","error")}},updateOverlayProp(t,e){const s=this.currentOverlay();s&&(s[t]=e,this.saveOverlaySettings())},addElement(t){const e=this.currentOverlay();e&&(t==="court"?e.elements.push({type:"court",court_id:this.addElCourtId||"1",visible:!0,x:100,y:100,w:460,show_logo:!0,font_size:17,bg_opacity:.95,logo_size:60,zone:"free",label_text:"KORT "+(this.addElCourtId||"1"),label_position:"above",label_gap:4,label_bg_opacity:.85,label_font_size:14}):e.elements.push({type:"stats",court_id:this.addElCourtId||"1",visible:!0,x:100,y:400,w:360,zone:"free"}),this.selectedElIdx=e.elements.length-1,this.saveOverlaySettings())},removeElement(){const t=this.currentOverlay();!t||this.selectedElIdx<0||(t.elements.splice(this.selectedElIdx,1),this.selectedElIdx=-1,this.saveOverlaySettings())},setElProp(t,e){const s=this.selectedEl();s&&(s[t]=e,this.saveOverlaySettings())},setDimension(t,e){const s=this.selectedEl();if(s){if(t==="h"&&!e){delete s.h,this.saveOverlaySettings();return}if(this.keepAspectRatio&&e!=null){const r=s.w||460,a=s.h||this._measureElHeight()||80,o=r/a;t==="w"?(s.w=e,s.h=Math.round(e/o)):(s.h=e,s.w=Math.round(e*o))}else s[t]=e;this.saveOverlaySettings()}},_measureElHeight(){if(this.selectedElIdx<0)return null;const t=this.$refs.canvasInner;if(!t)return null;const s=t.querySelectorAll(".drag-el")[this.selectedElIdx];return s?Math.round(s.offsetHeight):null},startDrag(t,e){var i,h;if(this.resizing)return;const s=this.$refs.canvasOuter;if(!s)return;const r=s.getBoundingClientRect(),a=this.canvasScale,o=this.currentElements()[e];if(!o)return;const n=o.x*a,l=o.y*a;this.dragging={idx:e,offsetX:t.clientX-r.left-n,offsetY:t.clientY-r.top-l},this.selectedElIdx=e,(h=(i=t.target).setPointerCapture)==null||h.call(i,t.pointerId)},onDrag(t){var h;if(this.resizing){this._onResize(t);return}if(!this.dragging)return;const e=this.$refs.canvasOuter;if(!e)return;const s=e.getBoundingClientRect(),r=this.canvasScale,a=this.currentElements()[this.dragging.idx];if(!a)return;const o=this.currentOverlay();if(a.zone==="top"&&((h=o==null?void 0:o.top_bar)!=null&&h.enabled))return;let n=(t.clientX-s.left-this.dragging.offsetX)/r,l=(t.clientY-s.top-this.dragging.offsetY)/r;const i=this._snapPosition(n,l,a.w||460,a.h||80);a.x=Math.max(-200,Math.min(2120,i.x)),a.y=Math.max(-200,Math.min(1280,i.y))},async endDrag(t){if(this.resizing){this.resizing=null,await this.saveOverlaySettings();return}this.dragging&&(this.dragging=null,await this.saveOverlaySettings())},startResize(t,e,s){var i,h;const r=this.currentElements()[e];if(!r)return;const a=this.$refs.canvasInner,n=(a?a.querySelectorAll(".drag-el"):[])[e],l=r.h||(n?Math.round(n.offsetHeight):80);this.resizing={idx:e,handle:s,startMouseX:t.clientX,startMouseY:t.clientY,startW:r.w,startH:l,startX:r.x,startY:r.y},this.selectedElIdx=e,(h=(i=t.target).setPointerCapture)==null||h.call(i,t.pointerId)},_onResize(t){const e=this.resizing;if(!e)return;const s=this.canvasScale,r=(t.clientX-e.startMouseX)/s,a=(t.clientY-e.startMouseY)/s,o=this.currentElements()[e.idx];if(!o)return;const n=e.handle;let l=e.startW,i=e.startH,h=e.startX,u=e.startY;if(n.includes("e")&&(l=e.startW+r),n.includes("w")&&(l=e.startW-r,h=e.startX+r),n.includes("s")&&(i=e.startH+a),n.includes("n")&&(i=e.startH-a,u=e.startY+a),this.keepAspectRatio&&e.startW>0&&e.startH>0){const c=e.startW/e.startH;n==="e"||n==="w"?i=l/c:n==="n"||n==="s"?l=i*c:i=l/c}o.w=Math.max(100,Math.min(1920,Math.round(l))),o.h=Math.max(30,Math.min(1080,Math.round(i))),o.x=Math.max(-200,Math.min(2120,Math.round(h))),o.y=Math.max(-200,Math.min(1280,Math.round(u))),this._syncTopBarSizes(o)},renderLiveScoreboard(t){var O,z,C,k;const e=t.court_id,s=this.courtData[e]||{},r=s.A||{},a=s.B||{},o=((O=s.match_status)==null?void 0:O.active)||!1,n=s.current_set||1;t.logo_size;const l=t.bg_opacity!=null?t.bg_opacity:.95,i=[];for(let m=1;m<=3;m++){const w=r["set"+m],_=a["set"+m];(m<=n||w>0||_>0)&&i.push({idx:m,a:w||0,b:_||0})}for(;i.length<2;)i.push({idx:i.length+1,a:0,b:0});const h=((z=s.tie)==null?void 0:z.visible)||!1,u=h?((C=s.tie)==null?void 0:C.A)||0:r.points||"0",c=h?((k=s.tie)==null?void 0:k.B)||0:a.points||"0",f=h?" is-tiebreak":"",y=this.overlaySettings.tournament_logo,d=t.show_logo,p=o?"":"match-inactive",g="grid-template-columns:1fr auto repeat("+i.length+", auto);";function v(m,w,_){const x=s.serve===w;let I="";const M=m.flag_url||(m.flag_code?L(m.flag_code):"");M&&(I='<span class="sb-flag has-image" style="background-image:url('+M+')"></span>');const D=x?'<span class="sb-serve"><img src="data:image/svg+xml,%3Csvg xmlns=%27http://www.w3.org/2000/svg%27 viewBox=%270 0 36 36%27%3E%3Ccircle cx=%2718%27 cy=%2718%27 r=%2717%27 fill=%27%23C6E953%27/%3E%3Ccircle cx=%2718%27 cy=%2718%27 r=%2717%27 fill=%27none%27 stroke=%27%23fff%27 stroke-width=%272%27/%3E%3Cpath d=%27M5 11c4 8 14 14 26 6%27 fill=%27none%27 stroke=%27%23fff%27 stroke-width=%272%27/%3E%3Cpath d=%27M5 25c6-8 16-14 26-6%27 fill=%27none%27 stroke=%27%23fff%27 stroke-width=%272%27/%3E%3C/svg%3E" alt="serve" style="width:16px;height:16px;"></span>':"",P=m.surname||m.full_name||"‚Äî",j='<div class="sb-player-cell">'+I+'<span class="sb-name" data-full="'+P.replace(/"/g,"&quot;")+'">'+P+"</span>"+D+"</div>",N=w==="A"?u:c,A=o?'<div class="sb-metric pts'+f+'">'+N+"</div>":'<div class="sb-metric pts">‚Äî</div>',F=i.map(E=>{const R=w==="A"?E.a:E.b;return'<div class="sb-metric set'+(E.idx===n?" is-active":"")+'">'+R+"</div>"}).join("");return'<div class="sb-row '+_+'" style="'+g+'">'+j+A+F+"</div>"}let b="";d&&(y?b='<div class="sb-logo"><img src="'+y+'" alt=""></div>':b='<div class="sb-logo"><div class="sb-logo-ph">üéæ</div></div>');let T="";if(o&&s.match_time){const m=s.match_time;let w=m.seconds||0;m.running&&m.resume_ts&&(w+=Date.now()/1e3-m.resume_ts),w+=m.offset_seconds||0,w=Math.max(0,Math.floor(w));const _=String(Math.floor(w/3600)).padStart(2,"0"),x=String(Math.floor(w%3600/60)).padStart(2,"0");T='<div class="sb-time-bar"><span class="time-icon">&#9201;</span> '+_+":"+x+"</div>"}const B=t.h?" h-fill":"",$=l<1?"opacity:"+l+";":"";return'<div class="sb-wrap '+p+B+'">'+b+'<div style="flex:1;min-width:0;"><div class="sb-table" style="'+$+'">'+v(r,"A","side-a")+v(a,"B","side-b")+"</div>"+T+"</div></div>"},_calcMatchTime(t){var o;if(!t||!((o=t.match_status)!=null&&o.active)||!t.match_time)return null;const e=t.match_time;let s=e.seconds||0;e.running&&e.resume_ts&&(s+=Date.now()/1e3-e.resume_ts),s+=e.offset_seconds||0,s=Math.max(0,Math.floor(s));const r=String(Math.floor(s/3600)).padStart(2,"0"),a=String(Math.floor(s%3600/60)).padStart(2,"0");return r+":"+a},renderCourtElement(t){const e=this.renderLiveScoreboard(t),s=!!t.h,r=t.label_position||"above",a=t.label_text&&r!=="none";let o="";if(a){const n="rgba(0,0,0,"+(t.label_bg_opacity!=null?t.label_bg_opacity:.7)+")",l=t.label_font_size||14,i=r==="below"?" label-below":"",h=this.courtData[t.court_id]||{},u=this._calcMatchTime(h),c=u?'<span class="label-sep">|</span><span class="label-time">‚è± '+u+"</span>":"";o='<div class="sb-label-bar'+i+'" style="background:'+n+";font-size:"+l+'px;"><span class="label-text">'+t.label_text+"</span>"+c+"</div>"}if(s){const n='<div style="flex:1;min-height:0;display:flex;flex-direction:column;">'+e+"</div>";return'<div class="overlay-container" style="height:100%;display:flex;flex-direction:column;">'+(r==="above"?o+n:n+o)+"</div>"}return'<div class="overlay-container">'+(r==="above"?o+e:e+o)+"</div>"},_abbreviateName(t){const e=t.trim().split(/\s+/);if(e.length<2)return t;const s=e[e.length-1];return e.slice(0,-1).map(a=>a.charAt(0).toUpperCase()+".").join(" ")+" "+s},_sv(t,e){return t!=null?t+(e||""):"‚Äî"},_serveRatio(t,e){return t!=null&&e!=null?t+"/"+e:"‚Äî"},_totalPtsWon(t,e){return(t.aces||0)+(t.winners||0)+(e.double_faults||0)+(e.forced_errors||0)+(e.unforced_errors||0)},renderStatsPanel(t){var p;const e=this.courtData[t.court_id]||{};if(!(((p=e.match_status)==null?void 0:p.active)||!1))return'<div class="sp-title">Statystyki</div><div style="text-align:center;opacity:0.4;font-size:11px;">Brak aktywnego meczu</div>';const r=e.stats||{},a=e.A||{},o=e.B||{},n=a.surname||a.full_name||"A",l=o.surname||o.full_name||"B",i=r.player_a||{},h=r.player_b||{},u=t.stats_mode||"simple",c=[{l:"Asy",a:this._sv(i.aces),b:this._sv(h.aces)},{l:"Podw. b≈Çƒôdy",a:this._sv(i.double_faults),b:this._sv(h.double_faults)},{l:"Winnery",a:this._sv(i.winners),b:this._sv(h.winners)}];u==="advanced"&&c.push({l:"B≈Ç. wymuszone",a:this._sv(i.forced_errors),b:this._sv(h.forced_errors)}),c.push({l:"B≈Ç. niewymuszone",a:this._sv(i.unforced_errors),b:this._sv(h.unforced_errors)}),u==="advanced"&&c.push({l:"1. serwis",a:this._serveRatio(i.first_serves_in,i.first_serves_total),b:this._serveRatio(h.first_serves_in,h.first_serves_total)}),c.push({l:"1. serwis %",a:this._sv(i.first_serve_pct,"%"),b:this._sv(h.first_serve_pct,"%")}),u==="advanced"&&(c.push({l:"2. serwis %",a:this._sv(i.second_serve_pct,"%"),b:this._sv(h.second_serve_pct,"%")}),c.push({l:"Pkt wygrane",a:this._totalPtsWon(i,h),b:this._totalPtsWon(h,i)}));const f=u==="advanced"?"Statystyki zaawansowane":"Statystyki",y='<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:2px;font-size:10px;font-weight:700;margin-bottom:6px;opacity:0.7;"><div></div><div style="text-align:center;">'+this._abbreviateName(n)+'</div><div style="text-align:center;">'+this._abbreviateName(l)+"</div></div>",d=c.map(g=>'<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:2px;font-size:11px;padding:2px 0;"><div style="opacity:0.7;">'+g.l+'</div><div style="text-align:center;font-weight:600;">'+g.a+'</div><div style="text-align:center;font-weight:600;">'+g.b+"</div></div>").join("");return'<div class="sp-title">'+f+"</div>"+y+d},_fitPreviewNames(){this.$nextTick(()=>{requestAnimationFrame(()=>{document.querySelectorAll(".sb-name").forEach(t=>{t.style.transform="",t.style.overflow="hidden";const e=t.getAttribute("data-full")||t.textContent;t.textContent=e;let s=t.scrollWidth;const r=t.clientWidth;if(s<=r+1)return;let a=r/s;if(a>=.75){t.style.overflow="visible",t.style.transform="scaleX("+a+")",t.style.transformOrigin="left center";return}const o=this._abbreviateName(e);o!==e&&(t.textContent=o,s=t.scrollWidth),s>r+1&&(a=r/s,t.style.overflow="visible",t.style.transform="scaleX("+Math.max(a,.55)+")",t.style.transformOrigin="left center")})})})},onLogoFileSelect(t){var r;const e=(r=t.target.files)==null?void 0:r[0];if(!e)return;const s=new FileReader;s.onload=a=>{this.cropImgSrc=a.target.result,this.cropZoom=100,this._cropOffset={x:0,y:0},this.$refs.cropModal.showModal(),this.$nextTick(()=>this.updateCropTransform())},s.readAsDataURL(e)},updateCropTransform(){const t=this.$refs.cropImg;if(!t)return;const e=this.cropZoom/100;t.style.width=200*e+"px",t.style.height="auto",t.style.left=this._cropOffset.x+"px",t.style.top=this._cropOffset.y+"px"},startCropDrag(t){var e,s;this._cropDragging=!0,this._cropStart={x:t.clientX-this._cropOffset.x,y:t.clientY-this._cropOffset.y},(s=(e=t.target).setPointerCapture)==null||s.call(e,t.pointerId)},onCropDrag(t){this._cropDragging&&(this._cropOffset={x:t.clientX-this._cropStart.x,y:t.clientY-this._cropStart.y},this.updateCropTransform())},endCropDrag(){this._cropDragging=!1},async applyCrop(){const t=document.createElement("canvas");t.width=200,t.height=200;const e=t.getContext("2d"),s=this.$refs.cropImg;if(!s)return;const a=200*(this.cropZoom/100),o=s.naturalHeight*(a/s.naturalWidth);e.drawImage(s,this._cropOffset.x,this._cropOffset.y,a,o);const n=t.toDataURL("image/png");this.$refs.cropModal.close();try{const l=await fetch("/api/overlay/logo",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({logo:n})});if(!l.ok)throw new Error("Upload failed");const i=await l.json();this.overlaySettings.tournament_logo=i.tournament_logo||n,this.showToast("Logo zapisane","success")}catch{this.showToast("B≈ÇƒÖd uploadu logo","error")}},async removeLogo(){try{await fetch("/api/overlay/logo",{method:"DELETE"}),this.overlaySettings.tournament_logo=null,this.showToast("Logo usuniƒôte","success")}catch{this.showToast("B≈ÇƒÖd usuwania logo","error")}},async copyUrl(t){try{await navigator.clipboard.writeText(t),this.showToast("URL skopiowany do schowka","success")}catch{const s=document.createElement("textarea");s.value=t,document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s),this.showToast("URL skopiowany","success")}}}));S.start();
