<!DOCTYPE html>
<html lang="pl">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Panel administracyjny</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>­čÄż</text></svg>">
    <meta name="theme-color" content="#4CAF50">
    
    <link rel="stylesheet" href="/static/styles.css" />
    <link rel="stylesheet" href="/static/toast.css" />
    <link rel="stylesheet" href="/static/modal.css" />
    <script src="/static/js/toast.js"></script>
    <script src="/static/js/modal.js"></script>
    <script src="/static/js/admin.js?v=20251109-3" defer></script>
  </head>
  <body
    data-authenticated="{{ 'true' if is_authenticated else 'false' }}"
    data-admin-enabled="{{ 'true' if admin_enabled else 'false' }}"
  >
    <!-- Dark Mode Toggle -->
    <button id="dark-mode-toggle" class="dark-mode-toggle" aria-label="Przełącz tryb ciemny" title="Przełącz tryb ciemny">
      <span class="dark-mode-toggle__icon">­čîÖ</span>
    </button>
    
    <main class="container">
      <h1>Panel administracyjny</h1>
      <div id="admin-feedback" class="feedback" role="alert" aria-live="polite"></div>

      <section id="admin-disabled-section" {% if admin_enabled %}hidden{% endif %}>
        <h2>Panel wyłączony</h2>
        <p>{{ admin_disabled_message }}</p>
        <p>
          Ustaw zmienną środowiskową <code>ADMIN_PASSWORD</code>, a następnie zrestartuj usługę,
          aby włączyć logowanie administratora.
        </p>
      </section>

      <section
        id="login-section"
        {% if is_authenticated or not admin_enabled %}hidden{% endif %}
      >
        <h2>Dostęp chroniony</h2>
        <p>Podaj hasło administratora, aby uzyskać dostęp do historii spotkań.</p>
        <form id="admin-login-form">
          <label for="admin-password">Hasło</label>
          <input id="admin-password" name="password" type="password" required />
          <button type="submit">Zaloguj</button>
        </form>
      </section>

      <!-- Dashboard Section -->
      <section id="dashboard-section" {% if not is_authenticated or not admin_enabled %}hidden{% endif %}>
        <header class="section-header">
          <h2>Dashboard Kortów</h2>
          <div class="section-actions">
            <button id="dashboard-refresh" type="button" data-tooltip="Odśwież widok kortów">­čöä Odśwież</button>
          </div>
        </header>
        <div id="courts-grid" class="courts-grid">
          <!-- Courts will be dynamically inserted here -->
        </div>
      </section>

      <section id="stream-section" {% if not is_authenticated or not admin_enabled %}hidden{% endif %}>
        <header class="section-header">
          <h2>Transmisja YouTube</h2>
          <div class="section-actions">
            <button id="refresh-viewers" type="button" data-tooltip="Pobierz aktualną liczbę widzów">Odśwież widzów</button>
          </div>
        </header>
        <form id="youtube-config-form" class="youtube-config-form">
          <div class="youtube-config-grid">
            <label for="youtube-api-key">Klucz API YouTube</label>
            <input id="youtube-api-key" name="api_key" type="text" autocomplete="off" />
            <label for="youtube-stream-id">ID transmisji</label>
            <input id="youtube-stream-id" name="stream_id" type="text" autocomplete="off" />
          </div>
          <p class="youtube-config-note">
            Wprowadź klucz API oraz identyfikator transmisji, aby pobierać liczbę widzów.
          </p>
          <button type="submit">Zapisz konfigurację</button>
        </form>
        <p class="viewer-info">
          Aktualna liczba widzów: <strong id="viewer-count">0</strong>
        </p>
        <p id="viewer-status" class="viewer-status" hidden></p>
      </section>

      <section id="system-section" {% if not is_authenticated or not admin_enabled %}hidden{% endif %}>
        <header class="section-header">
          <h2>System</h2>
        </header>
        <div id="uno-status-card" class="system-card">
          <div class="system-card__icon" aria-hidden="true">⚙</div>
          <div class="system-card__content">
            <div class="system-card__header">
              <label class="toggle">
                <input id="uno-requests-toggle" type="checkbox" />
                <span class="toggle-switch"></span>
                <span>Wysyłaj zapytania do UNO</span>
              </label>
              <div class="system-card__actions">
                <button id="uno-activity-reset" type="button" class="button-secondary" data-tooltip="Przywróć normalny tryb zapytań UNO">Stan normalny</button>
              </div>
            </div>
            <p id="uno-toggle-status" class="system-note">
              Gdy opcja jest wyłączona, żadne komendy nie są wysyłane do UNO.
            </p>
            <dl class="uno-metrics">
              <div class="uno-metric">
                <dt>Dzienny limit</dt>
                <dd id="uno-daily-summary">—</dd>
                <dd class="uno-metric__hint">Dane z nagłówka UNO</dd>
              </div>
              <div class="uno-metric">
                <dt>Godzinowy limit <span class="live-indicator" style="color: #4CAF50; font-size: 0.8em;">●</span></dt>
                <dd id="uno-hourly-summary">—</dd>
                <dd class="uno-metric__hint">Okno przesuwne 60 min ÔÇó Odświeżane co 2s</dd>
              </div>
              <div class="uno-metric">
                <dt>Status</dt>
                <dd id="uno-status-label">—</dd>
              </div>
            </dl>
            <p id="uno-activity-note" class="system-note" hidden></p>
            <p id="uno-auto-disabled" class="system-note" hidden></p>
            <form id="uno-poller-form" class="uno-poller-form">
              <fieldset class="uno-poller-fieldset">
                <legend>Limity na kort</legend>
                <div class="uno-poller-grid">
                  <label for="uno-hourly-limit">Limit/h (na kort)</label>
                  <input id="uno-hourly-limit" name="limit" type="number" min="0" step="1" />
                  <label for="uno-slowdown-threshold">Spowolnij przy (%)</label>
                  <input
                    id="uno-slowdown-threshold"
                    name="threshold_percent"
                    type="number"
                    min="0"
                    max="100"
                    step="1"
                  />
                  <label for="uno-slowdown-factor">Przepuść co n-te zapytanie</label>
                  <input id="uno-slowdown-factor" name="slowdown_factor" type="number" min="1" step="1" />
                  <label for="uno-slowdown-sleep">Dodatkowa pauza (s)</label>
                  <input id="uno-slowdown-sleep" name="slowdown_sleep" type="number" min="0" step="0.5" />
                </div>
                <div class="uno-poller-actions">
                  <button type="submit">Zapisz limity</button>
                </div>
              </fieldset>
            </form>
            <div id="uno-rate-limit-meta" class="uno-rate-meta" hidden>
              <p class="uno-rate-meta__item">
                Nagłówek: <span id="uno-rate-limit-header">—</span>
              </p>
              <p class="uno-rate-meta__item">
                Reset limitu: <span id="uno-rate-limit-reset">—</span>
              </p>
              <p class="uno-rate-meta__item">
                Ostatnia aktualizacja: <span id="uno-rate-limit-updated">—</span>
              </p>
            </div>
          </div>
        </div>
        <div class="system-toggle">
          <label class="toggle">
            <input id="plugin-toggle" type="checkbox" />
            <span class="toggle-switch"></span>
            <span>Używaj wtyczki</span>
          </label>
          <p id="plugin-toggle-status" class="system-note">
            Gdy opcja jest wyłączona, komunikaty od wtyczki będą ignorowane — pracujemy tylko z UNO.
          </p>
        </div>
      </section>

      <section id="players-section" {% if not is_authenticated or not admin_enabled %}hidden{% endif %}>
        <header class="section-header">
          <h2>Listy zawodników</h2>
          <div class="section-actions">
            <button id="refresh-players" type="button" data-tooltip="Odśwież listę graczy z serwera">Odśwież</button>
          </div>
        </header>
        <form id="player-form" class="player-form">
          <div class="player-form-grid">
            <label for="player-name-input">Imię i nazwisko</label>
            <input id="player-name-input" name="name" type="text" required />
            <label for="player-list-input">Lista</label>
            <input id="player-list-input" name="list_name" type="text" placeholder="default" />
            <label for="player-group-input">Grupa</label>
            <select id="player-group-input" name="group_category">
              <option value="">Brak</option>
              <option value="B1">B1</option>
              <option value="B2">B2</option>
              <option value="B3">B3</option>
              <option value="B4">B4</option>
            </select>
            <label for="player-flag-code-input">Kod kraju (np. pl)</label>
            <input
              id="player-flag-code-input"
              name="flag_code"
              type="text"
              maxlength="2"
              list="flag-code-options"
            />
            <label for="player-flag-url-input">Adres flagi</label>
            <input id="player-flag-url-input" name="flag_url" type="url" placeholder="https://" />
          </div>
          <p class="player-form-note">
            Grupa i kod kraju są opcjonalne. Format importu: <code>Imię Nazwisko Grupa KOD</code> (np. John Smith B1 us)
          </p>
          <button type="submit">Dodaj zawodnika</button>
        </form>
        <form id="player-import-form" class="player-import-form" enctype="multipart/form-data">
          <label for="player-import-file">Importuj graczy z pliku</label>
          <input
            id="player-import-file"
            name="file"
            type="file"
            accept=".txt,.csv,.tsv,text/plain"
            required
          />
          <button type="submit">Importuj</button>
          <p class="player-import-note">Format: Imię Nazwisko kod_kraju (np. Jan Kowalski PL).</p>
        </form>
        <datalist id="flag-code-options"></datalist>
        
        <!-- Search/Filter -->
        <div class="table-controls">
          <input 
            type="search" 
            id="players-search" 
            class="search-input" 
            placeholder="­čöŹ Szukaj gracza (nazwa, lista, grupa)..."
            aria-label="Szukaj graczy"
          />
          <select id="players-filter-group" class="filter-select" aria-label="Filtruj po grupie">
            <option value="">Wszystkie grupy</option>
            <option value="B1">B1</option>
            <option value="B2">B2</option>
            <option value="B3">B3</option>
            <option value="B4">B4</option>
          </select>
          <button id="players-clear-filters" class="button-secondary" type="button">Wyczyść filtry</button>
        </div>
        
        <div class="players-table-wrapper">
          <table class="players-table">
            <thead>
              <tr>
                <th style="width: 48px;">Flaga</th>
                <th class="sortable" data-sort="name">
                  Imię i nazwisko <span class="sort-icon">↕</span>
                </th>
                <th class="sortable" data-sort="list">
                  Lista <span class="sort-icon">↕</span>
                </th>
                <th class="sortable" data-sort="group">
                  Grupa <span class="sort-icon">↕</span>
                </th>
                <th>Kod kraju</th>
                <th>URL flagi</th>
                <th>Akcje</th>
              </tr>
            </thead>
            <tbody id="players-rows">
              {% for player in players %}
              <tr data-player-id="{{ player.id }}">
                <td class="flag-cell">
                  {% if player.flag_url %}
                  <img 
                    src="{{ player.flag_url }}" 
                    alt="{{ player.flag_code or '' }}" 
                    class="flag-preview"
                    onerror="this.classList.add('error')"
                  />
                  {% else %}
                  <span style="color: var(--muted); font-size: 11px;">—</span>
                  {% endif %}
                </td>
                <td><input name="name" type="text" value="{{ player.name or '' }}" /></td>
                <td><input name="list_name" type="text" value="{{ player.list_name or '' }}" /></td>
                <td><input name="group_category" type="text" value="{{ player.group_category or '' }}" maxlength="2" placeholder="B1-B4" /></td>
                <td>
                  <input
                    name="flag_code"
                    type="text"
                    maxlength="2"
                    list="flag-code-options"
                    value="{{ player.flag_code or '' }}"
                  />
                </td>
                <td><input name="flag_url" type="url" value="{{ player.flag_url or '' }}" placeholder="https://" /></td>
                <td class="actions">
                  <button class="update-player" type="button">Zapisz</button>
                  <button class="delete-player" type="button">Usuń</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section id="courts-section" {% if not is_authenticated or not admin_enabled %}hidden{% endif %}>
        <header class="section-header">
          <h2>Korty</h2>
          <div class="section-actions">
            <button id="refresh-courts" type="button">Odśwież</button>
          </div>
        </header>
        <form id="court-form" class="court-form">
          <div class="court-form-grid">
            <label for="court-id-input">ID kortu</label>
            <input id="court-id-input" name="kort_id" type="text" required />
            <label for="court-overlay-input">Overlay ID</label>
            <input id="court-overlay-input" name="overlay_id" type="text" />
          </div>
          <p class="court-form-note">Pozostaw pole puste, aby zapisać kort bez powiązanego overlay ID.</p>
          <button type="submit">Zapisz kort</button>
        </form>
        <div class="courts-table-wrapper">
          <table class="courts-table">
            <thead>
              <tr>
                <th>Kort</th>
                <th>Overlay ID</th>
                <th>PIN</th>
                <th>Akcje</th>
              </tr>
            </thead>
            <tbody id="courts-rows">
              {% for court in courts %}
              <tr data-kort-id="{{ court.kort_id }}">
                <td class="kort-id">{{ court.kort_id }}</td>
                <td class="overlay-id">{{ court.overlay_id or '' }}</td>
                <td class="pin-cell">
                  <input type="text" class="pin-input" value="{{ court.pin or '0000' }}" maxlength="10" style="width: 80px;" />
                  <button class="save-pin" type="button" style="margin-left: 5px;">Zapisz</button>
                </td>
                <td class="actions">
                  <button class="reset-court" type="button">Resetuj</button>
                  <button class="delete-court" type="button">Usuń</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>

      <section id="history-section" {% if not is_authenticated or not admin_enabled %}hidden{% endif %}>
        <header class="section-header">
          <h2>Historia spotkań</h2>
          <div class="section-actions">
            <button id="refresh-history" type="button">Odśwież</button>
          </div>
        </header>
        <div class="history-table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>ID</th>
                <th>Kort</th>
                <th>Zakończono</th>
                <th>Czas (s)</th>
                <th>Kategoria</th>
                <th>Faza</th>
                <th>Zawodnik A</th>
                <th>Zawodnik B</th>
                <th>Set 1 (A)</th>
                <th>Set 1 (B)</th>
                <th>Set 2 (A)</th>
                <th>Set 2 (B)</th>
                <th>Super Tie A</th>
                <th>Super Tie B</th>
                <th>TB1 A</th>
                <th>TB1 B</th>
                <th>TB2 A</th>
                <th>TB2 B</th>
                <th>Akcje</th>
              </tr>
            </thead>
            <tbody id="history-rows">
              {% for entry in history %}
              <tr data-entry-id="{{ entry.id }}">
                <td class="id">{{ entry.id }}</td>
                <td><input name="kort_id" type="text" value="{{ entry.kort_id or '' }}" /></td>
                <td><input name="ended_ts" type="text" value="{{ entry.ended_ts or '' }}" /></td>
                <td><input name="duration_seconds" type="number" value="{{ entry.duration_seconds or '' }}" /></td>
                <td><input name="category" type="text" value="{{ entry.category or '' }}" /></td>
                <td><input name="phase" type="text" value="{{ entry.phase or '' }}" /></td>
                <td><input name="player_a" type="text" value="{{ entry.player_a or '' }}" /></td>
                <td><input name="player_b" type="text" value="{{ entry.player_b or '' }}" /></td>
                <td><input name="set1_a" type="number" value="{{ entry.set1_a or '' }}" /></td>
                <td><input name="set1_b" type="number" value="{{ entry.set1_b or '' }}" /></td>
                <td><input name="set2_a" type="number" value="{{ entry.set2_a or '' }}" /></td>
                <td><input name="set2_b" type="number" value="{{ entry.set2_b or '' }}" /></td>
                <td><input name="tie_a" type="number" value="{{ entry.tie_a or '' }}" /></td>
                <td><input name="tie_b" type="number" value="{{ entry.tie_b or '' }}" /></td>
                <td><input name="set1_tb_a" type="number" value="{{ entry.set1_tb_a or '' }}" /></td>
                <td><input name="set1_tb_b" type="number" value="{{ entry.set1_tb_b or '' }}" /></td>
                <td><input name="set2_tb_a" type="number" value="{{ entry.set2_tb_a or '' }}" /></td>
                <td><input name="set2_tb_b" type="number" value="{{ entry.set2_tb_b or '' }}" /></td>
                <td class="actions">
                  <button class="update-entry" type="button">Zapisz</button>
                  <button class="delete-entry" type="button">Usuń</button>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </section>
    </main>
    <script id="admin-initial-data" type="application/json">{{ {
      'is_authenticated': is_authenticated,
      'history': history,
      'courts': courts,
      'players': players,
  'uno_requests_enabled': uno_requests_enabled,
  'plugin_enabled': plugin_enabled,
  'uno_rate_limit': uno_rate_limit | default({}),
  'uno_hourly_usage': uno_hourly_usage | default({}),
  'uno_hourly_config': uno_hourly_config | default({}),
  'uno_auto_disabled_reason': uno_auto_disabled_reason | default(''),
      'int_fields': int_fields,
      'admin_enabled': admin_enabled,
      'admin_disabled_message': admin_disabled_message,
    } | tojson }}</script>
  </body>
</html>
