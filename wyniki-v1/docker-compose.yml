version: "3.8"

services:
  wyniki:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wyniki-tenis
    restart: unless-stopped
    ports:
      - "8087:8080"    # lokalnie; Traefik i tak trafi po IP:port
    environment:
      # UNO / Overlays
      UNO_BASE: ${UNO_BASE:-https://app.overlays.uno/apiv2/controlapps}
      KORT1_ID: ${KORT1_ID}
      KORT2_ID: ${KORT2_ID}
      KORT3_ID: ${KORT3_ID}
      KORT4_ID: ${KORT4_ID}
      # Jeśli potrzebujesz Bearer:
      UNO_AUTH_BEARER: ${UNO_AUTH_BEARER:-}
      # Limity per kort
      RPM_PER_COURT: ${RPM_PER_COURT:-55}
      BURST: ${BURST:-8}
      # Ścieżka bazy (w kontenerze)
      DB_PATH: /data/wyniki_archive.sqlite3
      PORT: 8080
      # Admin panel
      ADMIN_PASSWORD: ${ADMIN_PASSWORD}
      HISTORY_DELETE_PASSWORD: ${HISTORY_DELETE_PASSWORD:-}
    volumes:
      - wyniki_data:/data
    labels:
      - "traefik.enable=true"
      # Router
      - "traefik.http.routers.wyniki.rule=Host(`${PUBLIC_HOST}`)"
      - "traefik.http.routers.wyniki.entrypoints=https"
      - "traefik.http.routers.wyniki.tls=true"
      # Service (Traefik łączy po IP:port, bez sieci proxy)
      - "traefik.http.services.wyniki.loadbalancer.server.port=8080"
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:8080/healthz"]
      interval: 20s
      timeout: 3s
      retries: 5
    networks:
      - wyniki_net

  nginx-rtmp:
    image: tiangolo/nginx-rtmp:latest
    container_name: wyniki-rtmp
    restart: unless-stopped
    ports:
      - "1935:1935"    # RTMP input (OBS pushuje tutaj)
      - "8089:80"      # HLS playback (debug only)
    volumes:
      - ./nginx-rtmp.conf:/etc/nginx/nginx.conf:ro
      - ./stream.html:/var/www/stream.html:ro
      - rtmp_hls:/tmp/hls
    labels:
      - "traefik.enable=true"
      # Router dla HLS playback - poprawiona składnia dla Traefik v3
      - "traefik.http.routers.rtmp.rule=Host(`${PUBLIC_HOST}`) && (PathPrefix(`/hls`) || PathPrefix(`/stream`))"
      - "traefik.http.routers.rtmp.entrypoints=https"
      - "traefik.http.routers.rtmp.tls=true"
      - "traefik.http.services.rtmp.loadbalancer.server.port=80"
    networks:
      - wyniki_net

volumes:
  wyniki_data:
    external: true
    name: count_wyniki_data
  rtmp_hls:

networks:
  wyniki_net:
    driver: bridge
